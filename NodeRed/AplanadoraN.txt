[{"id":"cd40767d.83a838","type":"subflow","name":"Subflow 2","info":"","in":[{"x":107.1749267578125,"y":531.1888694763184,"wires":[{"id":"a1b48f0e.6b7838"}]}],"out":[{"x":1697.0958557128906,"y":674.3806419372559,"wires":[{"id":"976ff823.daa068","port":0}]}]},{"id":"229c4569.ca149a","type":"mongodb out","z":"cd40767d.83a838","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1213.600845336914,"y":641.4568243026733,"wires":[]},{"id":"ffe163b0.a46ae8","type":"function","z":"cd40767d.83a838","name":"collection inicial parametros","func":"msg.payload = {\n\t\"_id\": \"AplanadoraN3\",\n\t\"nome\": \"Aplanadora N3\",\n\t\"setor\": \"Estamparia\",\n\t\"parametros\": {\n\t\t\"encoder\": {\n\t\t\t\"fator\": 9999,\n\t\t\t\"resolucao\": 2500,\n\t\t\t\"perimetro\": 400\n\t\t},\n\t\t\"velocidade\": {\n\t\t\t\"automatico\": 100,\n\t\t\t\"manual\": 25\n\t\t},\n\t\t\"ferramenta\": {\n\t\t\t\"passo\": 200\n\t\t}\n\t},\n\t\"estado\": {\n\t\t\"situacao\": {\n\t\t\t\"codigo\": 99,\n\t\t\t\"descricao\": \"Maquina OK\"\n\t\t}\n\t},\n\t\"operador\": {\n\t\t\"codigo\": 1012,\n\t\t\"nome\": \"IRANILDO\"\n\t},\n\t\"os\": {\n\t    \"numero\": \"1231-11\",\n\t    \"produto\": {\n\t        \"codigo\": \"XXXXXXXXX\",\n\t        \"descricao\": \"AAAAAABBBBBCCCCC\"\n\t    },\n\t    \"quantidade\": 1550,\n\t    \"produzido\": 0,\n\t    \"refugo\": 0\n\t},\n\t\"lubrificacao\": {\n\t\t\"preset\": {\n\t\t        \"MbNovoCiclosUnd\":0,\n\t\t        \"MbNovoCiclosmil\":1\n\t\t},\n\t\t\"ciclos\": {\n\t\t        \"PrsCiclosUnid\":500,\n\t\t        \"PrsCiclosMil\":0\n\t\t}\n\t},\n\t\"timestamp\":new Date()\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":1006.6098327636719,"y":641.5616111755371,"wires":[["229c4569.ca149a"]]},{"id":"29ee96a6.165e72","type":"mongodb out","z":"cd40767d.83a838","mongodb":"1ff167d9.b1a58","name":"APAGAR TODA A COLLECTION log_erro","collection":"log_erro","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":705.3317565917969,"y":567.7559471130371,"wires":[]},{"id":"1cf158a.2ea8ea7","type":"mongodb out","z":"cd40767d.83a838","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"log_erro","payonly":true,"upsert":false,"multi":false,"operation":"store","x":1369.5785675048828,"y":680.112494468689,"wires":[]},{"id":"85457819.27025","type":"function","z":"cd40767d.83a838","name":"collection inicial log_erro","func":"msg.payload = {\n\t\"_id\": 1,\n\t\"log_mesagens\": {\n\t}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1162.5875549316406,"y":680.2172813415527,"wires":[["1cf158a.2ea8ea7"]]},{"id":"c7654a3d.f9ce58","type":"mongodb out","z":"cd40767d.83a838","mongodb":"1ff167d9.b1a58","name":"APAGAR TODA A COLLECTION parametros","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":544.7760620117188,"y":531.5337181091309,"wires":[]},{"id":"4696731f.ceb44c","type":"mongodb out","z":"cd40767d.83a838","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"indice","payonly":true,"upsert":false,"multi":true,"operation":"store","x":1527.6560325622559,"y":719.0737380981445,"wires":[]},{"id":"e07acb19.b3b8b","type":"function","z":"cd40767d.83a838","name":"collection inicial indice","func":"msg.payload = {\n\t\"_id\": \"indice\",\n\t\"indice_mesagens\": 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1321.1095275878906,"y":719.4006004333496,"wires":[["4696731f.ceb44c","976ff823.daa068"]]},{"id":"48eee216.f7e4cc","type":"mongodb out","z":"cd40767d.83a838","mongodb":"1ff167d9.b1a58","name":"APAGAR TODA A COLLECTION indice","collection":"indice","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":875.1835632324219,"y":605.0894584655762,"wires":[]},{"id":"ee06730a.34c5c","type":"function","z":"cd40767d.83a838","name":"Delay 150ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 150);\nreturn null;","outputs":1,"noerr":0,"x":444.97943115234375,"y":568.263973236084,"wires":[["29ee96a6.165e72","9d2e0a41.e02e78"]]},{"id":"9d2e0a41.e02e78","type":"function","z":"cd40767d.83a838","name":"Delay 150ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 150);\nreturn null;","outputs":1,"noerr":0,"x":615.9794616699219,"y":605.263973236084,"wires":[["48eee216.f7e4cc","23095ccf.7f86f4"]]},{"id":"23095ccf.7f86f4","type":"function","z":"cd40767d.83a838","name":"Delay 150ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 150);\nreturn null;","outputs":1,"noerr":0,"x":784.9794616699219,"y":641.263973236084,"wires":[["ffe163b0.a46ae8","67066442.6a92dc"]]},{"id":"67066442.6a92dc","type":"function","z":"cd40767d.83a838","name":"Delay 150ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 150);\nreturn null;","outputs":1,"noerr":0,"x":955.8794250488281,"y":680.263973236084,"wires":[["85457819.27025","e059db44.620a18"]]},{"id":"e059db44.620a18","type":"function","z":"cd40767d.83a838","name":"Delay 150ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 150);\nreturn null;","outputs":1,"noerr":0,"x":1121.9794006347656,"y":719.263973236084,"wires":[["e07acb19.b3b8b"]]},{"id":"976ff823.daa068","type":"function","z":"cd40767d.83a838","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nreturn null;","outputs":1,"noerr":0,"x":1547.0958557128906,"y":674.3806419372559,"wires":[[]]},{"id":"a1b48f0e.6b7838","type":"function","z":"cd40767d.83a838","name":"string vazia","func":"msg.payload = {};\nreturn msg;","outputs":1,"noerr":0,"x":257.1749267578125,"y":531.1888694763184,"wires":[["c7654a3d.f9ce58","ee06730a.34c5c"]]},{"id":"1ff167d9.b1a58","type":"mongodb","z":"3fa7f249.e9d566","hostname":"127.0.0.1","port":"27017","db":"db","name":""},{"id":"88bd08dd.41c838","type":"subflow","name":"Subflow 1","info":"","in":[{"x":1141.6665935516357,"y":121.66666221618652,"wires":[{"id":"50f94c08.7ecd4c"}]}],"out":[]},{"id":"50f94c08.7ecd4c","type":"exec","z":"88bd08dd.41c838","command":"\"C:\\\\Program Files (x86)\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe\"","addpay":false,"append":"","useSpawn":false,"timer":"","name":"chrome","x":1252.0000610351562,"y":121.19442367553711,"wires":[["2de0f88c.21ed3"],["f13558f0.fa3568"],["10c29175.84387f"]]},{"id":"2de0f88c.21ed3","type":"function","z":"88bd08dd.41c838","name":"toString()","func":"msg.payload = msg.payload.toString()\nreturn msg;","outputs":1,"noerr":0,"x":1428.6667785644531,"y":58.49441146850586,"wires":[["e29e956b.82113"]]},{"id":"e29e956b.82113","type":"debug","z":"88bd08dd.41c838","name":"output","active":true,"console":"false","complete":"payload","x":1587.6667785644531,"y":58.49441146850586,"wires":[]},{"id":"f13558f0.fa3568","type":"function","z":"88bd08dd.41c838","name":"rc","func":"if (msg.control && (msg.control.state == 'end' || msg.control.state == 'error')) return { payload: msg.control.rc }","outputs":1,"noerr":0,"x":1420.6667785644531,"y":122.49441146850586,"wires":[["7adf60ff.43ada"]]},{"id":"7adf60ff.43ada","type":"debug","z":"88bd08dd.41c838","name":"rc","active":true,"console":"false","complete":"payload","x":1580.6667785644531,"y":122.49441146850586,"wires":[]},{"id":"10c29175.84387f","type":"function","z":"88bd08dd.41c838","name":"toString()","func":"msg.payload = msg.payload.toString()\nreturn msg;","outputs":1,"noerr":0,"x":1425.6667785644531,"y":184.49441146850586,"wires":[["16a14f0d.61e6c1"]]},{"id":"16a14f0d.61e6c1","type":"debug","z":"88bd08dd.41c838","name":"output2","active":true,"console":"false","complete":"payload","x":1603.6667785644531,"y":185.49441146850586,"wires":[]},{"id":"47bce84c.b01aa","type":"comment","z":"3fa7f249.e9d566","name":"Deserializador global \"Referencia\"","info":"var msgs = [];\nvar g = (global.get(\"M\")||[0]);\nfor(z = 0; z < g.length) {\nfor (i = 0; i < 15; i++) {\n    msgs.push(\n        {\n            _msgid: msg._msgid,\n            topic: msg.topic,\n            payload: g[z] & (1 << i)\n        }\n    );\n}\n}\n//var type = msg.payload[0] & 1 ? 'error' : 'warning';\n\n//var count = flow.get(\"CONTADOR_ERRO_M2\");\n//count++;\n\n\nreturn msgs;","x":1762.3387756347656,"y":1995.127773284912,"wires":[]},{"id":"ba701407.fcf678","type":"inject","z":"3fa7f249.e9d566","name":"Inicialização MAQ","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"","once":true,"x":1459.4876403808594,"y":549.5685997009277,"wires":[["d3de7088.a19c"]]},{"id":"1719b143.3669ef","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Estado da Maquina","topic":"AplanadoraN/Estado","qos":"0","retain":"false","broker":"4d1bed4f.c5b27c","x":3458.2851333618164,"y":1190.473403930664,"wires":[]},{"id":"6617a748.2fba5","type":"function","z":"3fa7f249.e9d566","name":"Global ModBus Referencias","func":"global.set(\"ModBus\", msg.payload);\nmsg2 = {};\nmsg2.payload = \"Iguail\";\nvar Anterior =(global.get(\"Anterior\")||[0]);\nvar ValorAtual = global.get(\"ModBus\");\nmsg = null;\n\nfor (var i = 0; i < Anterior.length; i++) {\n         \n     if (Anterior[i] != ValorAtual[i]) {\n        msg2.payload = \"Diferente\";\n        global.set(\"Anterior\", ValorAtual);\n        msg = {payload:ValorAtual};\n        break;\n    }           \n}\nreturn [msg,msg2];","outputs":"2","noerr":0,"x":1742.749610900879,"y":2035.8421478271484,"wires":[[],[]]},{"id":"ed7ba5e1.7d7ef","type":"mqtt in","z":"3fa7f249.e9d566","name":"","topic":"board/setup","qos":"2","broker":"4d1bed4f.c5b27c","x":559.773567199707,"y":1347.3900828361511,"wires":[["e3720039.3ff18","37014511.e596f2"]]},{"id":"e3720039.3ff18","type":"function","z":"3fa7f249.e9d566","name":"Registradores de Comandos","func":"var p = JSON.parse(msg.payload);\nvar res = [null,null,null,null,null,null,null,null,null,null,null,null,null];\nvar modbus = global.get(\"ModBus\");\n    \n    //***** INICIALIZA OU DESLIGA MAQUINA *****//\n    if (p.LigarMaquina !== undefined) {\n        if (modbus[2] & (1 << 11)) {\n            modbus[2] &= ~(1<<11);   //M2.11 igual a 1 MbLigaChaveGeral\n            node.status({fill:\"red\",shape:\"ring\",text:\"Geral Desligada\"});\n        } else {\n            modbus[2] |= (1<<11);    //M2.11 igual a 0 MbLigaChaveGeral\n            node.status({fill:\"green\",shape:\"dot\",text:\"Geral Ligada\"});\n        }\n    global.set(\"ComandoMaquina\",1);    \n    global.set('ModBus', modbus); //Atualiza registrador global.\n    res[0] = {payload:modbus[2]}; //Primeiro liga ou desliga chave geral\n    }\n    \n    //***** ON/OFF MOTOR *****//\n    if (p.LigarPrensa !== undefined) {\n        if ((modbus[3]) & (1 << 3)) {\n            modbus[3] &= ~(1<<3); //M3.3 igual a 1 DbPrsLigaMotor\n            global.set(\"MotorLigado\",0);\n            node.status({fill:\"red\",shape:\"ring\",text:\"Motor OFF\"});\n        } else {\n            modbus[3] |= (1<<3);//M3.3 igual a 0 DbPrsParar\n            global.set(\"MotorLigado\",1);\n            node.status({fill:\"green\",shape:\"dot\",text:\"Motor ON\"});\n        }\n    global.set(\"ComandoMaquina\",2);\n    global.set('ModBus', modbus);//Atualiza registrador global.\n    res[1] = {payload: modbus[3]};\n    }\n    \n    //***** ABRIR TAMPA MODBUS 31.10 *****//\n    if (p.abrirTampa !== undefined) {\n        if (p.abrirTampa == '1'){\n            modbus[31] |= (1<<10);    \n        }else if (p.abrirTampa == '0'){\n            modbus[31] = 0;    \n        }\n    global.set(\"ComandoMaquina\",3);\n    res[2] = {payload:(modbus[31])};\n    }\n    \n    //***** FECHAR TAMPA MODBUS 31.11 *****//\n    if (p.fecharTampa !== undefined) {\n        if(p.fecharTampa == '1'){\n            modbus[31] |= (1<<11);    \n        }else if (p.fecharTampa == '0'){\n            modbus[31] = 0;\n        }\n    global.set(\"ComandoMaquina\",4);\n    res[3] = {payload:(modbus[31])};\n    }\n    \n    //***** AVANCAR PERFIL MODBUS 2.3 *****//\n    if (p.avancaPerfil !== undefined) {\n        if(p.avancaPerfil == '1'){\n            modbus[2] |= (1<<3);    \n        }else if (p.avancaPerfil == '0'){\n            modbus[2] &= ~(1<<3);\n        }\n    global.set(\"ComandoMaquina\",5);\n    res[4] = {payload: modbus[2]};\n    }\n    //***** RECUAR PERFIL MODBUS 2.4 *****//\n    if (p.recuaPerfil !== undefined) {\n        if(p.recuaPerfil == '1'){\n            modbus[2] |= (1<<4);    \n        }else if (p.recuaPerfil == '0'){\n            modbus[2] &= ~(1<<4);\n        }\n    global.set(\"ComandoMaquina\",6);    \n    res[5] = {payload:modbus[2]};\n    }\n    \n    //*****botao_Parar_Maquina***********//\n    if (p.botao_Parar_Maquina !== undefined) {\n    modbus[2] |= (1<<13);   //M2.13 igual a 0 MbPrsParar\n    modbus[2] &= ~(1<<0);   //M2.0 igual a 0 MbModoAuto\n    node.status({fill:\"red\",shape:\"ring\",text:\"Parando prensa\"});\n    global.set(\"ComandoMaquina\",7);\n    global.set('ModBus', modbus);//Atualiza registrador global.\n    res[6] = {payload: modbus[2]};\n    }\n    \n    //*****botao_Manual************//\n    if (p.botao_Manual !== undefined) {\n    modbus[3] |= 1; //Libera maquina\n    modbus[2] &= ~(1<<0);   //M2.0 igual a 0 MbModoAuto\n    node.status({fill:\"red\",shape:\"ring\",text:\"Modo Manual\"});\n    global.set(\"ComandoMaquina\",8);\n    global.set('ModBus', modbus);//Atualiza registrador global.\n    res[7] = {payload: modbus[2]};\n    }\n    \n    //*****botao_Produzir*********//\n    if (p.botao_Produzir !== undefined) {\n        modbus[3] |= 1; //Libera maquina\n        if ((modbus[2]) & (1 << 0)) {\n            modbus[2] &= ~(1<<0); //M2.0 igual a 1 produzir\n            node.status({fill:\"green\",shape:\"dot\",text:\"Produzindo\"});\n        } else {\n            modbus[2] |= (1<<0);//M2.0 igual a 0 não produzir\n            node.status({fill:\"red\",shape:\"ring\",text:\"Não produzindo\"});\n        }\n    global.set(\"ComandoMaquina\",9);\n    global.set('ModBus', modbus);//Atualiza registrador global.\n    res[8] = {payload: modbus[2]};\n    }\n    \n    //***** Reverçao do motor da prensa *****//\n    if (p.SentidoInv !== undefined) {\n        if ((modbus[2]) & (1 << 14)) {\n            modbus[2] &= ~(1<<14); //M2.14 igual a 1 MbPrsSentidoInv\n            global.set(\"MotorInvertido\",0);\n            node.status({fill:\"blue\",shape:\"ring\",text:\"Motor normal\"});\n        } else {\n            modbus[2] |= (1<<14);//M3.3 igual a 0 DbPrsParar\n            global.set(\"MotorInvertido\",1);\n            node.status({fill:\"green\",shape:\"dot\",text:\"Motor Invertido\"});\n        }\n    global.set(\"ComandoMaquina\",10);\n    global.set('ModBus', modbus);//Atualiza registrador global.\n    res[9] = {payload: modbus[2]};\n    }\n    \n        //***** DESLIGA MAQUINA depois zera tudo *****//\n    if (p.ResetMaquina !== undefined) {\n    modbus[2] &= ~(1<<11); \n    node.status({fill:\"red\",shape:\"ring\",text:\"Geral Desligada e reset\"});\n    global.set(\"ComandoMaquina\",0);    \n    global.set('ModBus', modbus); //Atualiza registrador global.\n    res[10] = {payload:modbus[2]}; //Primeiro desliga chave geral\n    }\n    \n    //*****Desbobinador ******//\n    if (p.AceleracaoAuto !== undefined) {\n    var x = global.get(\"Desbobinador\");\n        if(x){\n            global.set('Desbobinador', 0);//Atualiza registrador global.\n        }else{\n            global.set('Desbobinador', 1);//Atualiza registrador global.\n        }\n    global.set(\"ComandoMaquina\",11);\n    res[11] = {payload: global.get(\"Desbobinador\")};\n    }\n    \n    //*****Atualiza TABS-2**************//\n    if (p.AtualizarRegistradores !== undefined) {\n    node.status({fill:\"red\",shape:\"ring\",text:\"Tab-2\"});\n    res[12] = {payload: 1};\n    }\n    \nreturn res;","outputs":"13","noerr":0,"x":856.9519958496094,"y":1348.1734886169434,"wires":[["6aa91690.0431f"],["e8108119.f3ede"],["402bd435.5ec41c"],["6b5900e9.98267"],["e47d5d6a.9bbdd"],["5bec9fa7.95f7"],["47762d37.68ecc4"],["1fed70fb.05872f"],["fededba1.6c3a08"],["ca2751b8.9961b"],["e33c6700.f7a53"],["8b0e1e9.7342a6"],["4a288932.ea285"]]},{"id":"e8108119.f3ede","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Liga Motor Prensa M3.3","dataType":"HoldingRegister","adr":"3","server":"d349ffba.2ed7d8","x":1237.300064086914,"y":1056.5758323669434,"wires":[["f2e9482d.949c9"],["1297d514.9ad473"]]},{"id":"e47d5d6a.9bbdd","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Perfil Avança M2.3","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1218.6811790466309,"y":1265.8613677024841,"wires":[["f8379be7.5fcec8"],["9e5fb3c7.ca9d58"]]},{"id":"6b5900e9.98267","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Aplanadora Fecha M31.11","dataType":"HoldingRegister","adr":"31","server":"d349ffba.2ed7d8","x":1228.9666442871094,"y":1197.43288230896,"wires":[["ffce9c75.a1ea5"],["d0a26883.48ac4"]]},{"id":"402bd435.5ec41c","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Aplanadora Abre M31.10","dataType":"HoldingRegister","adr":"31","server":"d349ffba.2ed7d8","x":1238.1095886230469,"y":1126.43288230896,"wires":[["2035530c.e0c28c"],["9b6c6b2e.a3902"]]},{"id":"5bec9fa7.95f7","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Perfil Recua M2.4","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1217.3953819274902,"y":1336.8612570762634,"wires":[["9853a9d6.613778"],["97e5436.b16884"]]},{"id":"46fcb540.2100fc","type":"comment","z":"3fa7f249.e9d566","name":"Registradores R/W Setup da Aplanadora \"HTML\"","info":"#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso","x":1222.5912780761719,"y":928.7971458435059,"wires":[]},{"id":"99f141c0.738eb8","type":"function","z":"3fa7f249.e9d566","name":"Erro comunicação Escrita","func":"msg.payload = {\n    time: new Date(),\n    type: 'error',\n    message: 'Falha de escrita dos modbus do CLP.'\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":3203.296127319336,"y":1190.0400505065918,"wires":[["1719b143.3669ef"]]},{"id":"b342f5d7.c59e78","type":"function","z":"3fa7f249.e9d566","name":"Variaveis Globais","func":"//Estado inicial da maquina é não inicializada MaqInicializada=0\nglobal.set(\"ComandoMaquina\",0);//liberamensagens do bloco libera maquina\nglobal.set(\"MotorPrensa\",0);\nglobal.set(\"MotorLigado\",0);\nglobal.set(\"MotorInvertido\",0);\nglobal.set(\"Desbobinador\",0);\nglobal.set(\"Indice_Mongo\",0);\nglobal.set(\"TamanhoDesejadoPeca_KEYBOARD\",0);\nglobal.set(\"TamanhoRealPeca_KEYBOARD\",0);\nglobal.set(\"FatorEncoder\",9909);\nglobal.set(\"ModBus\",[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);\nvar start = new Date().getTime();\nglobal.set(\"tempo\",start);\n\nvar mensagens = [];\n\nmensagens['LER_CLP_MODBUS'] =        { type: 'error', message: ' CLP não responde. Verifique as conexões de rede.' };\nmensagens['EMERGENCIA'] =            { type: 'error', message: ' Emergencia acionada!' };\nmensagens['FALTA_FASE'] =            { type: 'error', message: ' Falta de Fase' };\nmensagens['BOMBA_HIDRAULICA'] =      { type: 'error', message: ' Térmico da Bomba Hidraulica' };\nmensagens['MARTELO_PRENSA'] =        { type: 'error', message: ' Térmico do Motor do Martelo Prensa' };\nmensagens['PRESSAO_AR'] =            { type: 'warning', message: 'Pressao do Ar Baixa!' };\nmensagens['INVERSOR'] =              { type: 'error', message: ' Erro no Inversor' };\nmensagens['SERVO'] =                 { type: 'error', message: ' Erro no Servo' };\nmensagens['CHAVE_GERAL_DESLIGADA'] = { type: 'warning', message: ' Chave Geral Desligada' };\nmensagens['CHAVE_GERAL_LIGADA']    = { type: 'warning', message: ' Chave Geral ligada' };\nmensagens['MAQUINA_NAO_LIBERADA'] =  { type: 'warning', message: ' Maquina Não Liberada' };\nmensagens['MAQUINA_LIBERADA']     =  { type: 'warning', message: ' Maquina Liberada' };\nmensagens['ERRO_POSICIONAMENTO']=    { type: 'error', message: ' Erro Posicionamento' };\nmensagens['SEGURAN_PRENSA'] =        { type: 'info', message: ' Segurança da Prensa' };\nmensagens['APLAN_ABERTA'] =          { type: 'info', message: ' Aplanadora Aberda' };\n\nglobal.set(\"mensagens\",mensagens);\nmsg= {payload: \"{MAQUINA_OFF:0}\"};\nreturn msg;","outputs":1,"noerr":0,"x":2002.6660423278809,"y":551.1046643257141,"wires":[["483f884e.fb259"]]},{"id":"f9c4e8b0.40be08","type":"function","z":"3fa7f249.e9d566","name":"Ligou geral?","func":"//verifica 2.11 e libera 3.0\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n\nif (((modbus[2]) & (1 << 11))) {\n    modbus[3] |= 1;     //M3.0 igual a 1 libera maquina\n    msg.payload = modbus[3];\n    msg2.payload = mensagens['CHAVE_GERAL_LIGADA'];\n    msg2.payload.time= new Date();\n    node.status({fill:\"green\",shape:\"dot\",text:\"Chave Ligada\"});\n}else if (~((modbus[2]) & (1 << 11))){ \n    modbus[3] &= 0;\n    msg.payload = 0;\n    msg2.payload = mensagens['CHAVE_GERAL_DESLIGADA'];\n    msg2.payload.time= new Date();\n    node.status({fill:\"yellow\",shape:\"ring\",text:\"Chave Deslidaga\"});\n}else {\n    node.status({fill:\"red\",shape:\"ring\",text:\"Bug\"});\n}\n   \n\nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2142.4876136779785,"y":1001.5094475746155,"wires":[["9de229f4.002cf"],["7dc564c.cd80e1c"]]},{"id":"6aa91690.0431f","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"LigaGeral M2.11","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1217.3684997558594,"y":988.889669418335,"wires":[["61901287.5cc6bc"],["a255743e.0c3a48"]]},{"id":"393af405.b4ee64","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Libera Maquina M3.0","dataType":"HoldingRegister","adr":"3","server":"d349ffba.2ed7d8","x":2605.205764770508,"y":995.1559548377991,"wires":[["9dc48c65.c1cf48"],["2f02d021.a85c7"]]},{"id":"533ed6b.f9d71a8","type":"function","z":"3fa7f249.e9d566","name":"Erro comunicação","func":"var mensagens = global.get(\"mensagens\");\n//var modbus = global.get(\"ModBus\");\n\nmsg.payload = mensagens['LER_CLP_MODBUS'];\nmsg.payload.time= new Date();\n\n//global.set('ModBus', modbus);\nreturn msg;","outputs":1,"noerr":0,"x":1727.3754234313965,"y":491.44881105422974,"wires":[["96ef6800.4b4bd8","b342f5d7.c59e78"]]},{"id":"c607ffcf.0fa448","type":"modbustcp-no-pooling-read","z":"3fa7f249.e9d566","name":"Read POP","dataType":"HoldingRegister","adr":"0","quantity":"32","server":"d349ffba.2ed7d8","x":1477.9519004821777,"y":484.2861828804016,"wires":[["a38fd428.2ddb1","22993306.c46814"],["533ed6b.f9d71a8"]]},{"id":"78865e2c.239d28","type":"inject","z":"3fa7f249.e9d566","name":"atualizar","topic":"","payload":"","payloadType":"date","repeat":"5","crontab":"","once":false,"x":1105.6303062438965,"y":483.78294801712036,"wires":[["a47d4454.d544e"]]},{"id":"b9410cf8.14726","type":"link in","z":"3fa7f249.e9d566","name":"Atualizacao dos 32 registradores  ModBus","links":["8cba0a67.42a0b8","2035530c.e0c28c","ffce9c75.a1ea5","f8379be7.5fcec8","9853a9d6.613778","8b0e1e9.7342a6"],"x":1717.0829162597656,"y":1170.5732078552246,"wires":[["df391f71.ea453"]]},{"id":"ade245d0.7b73d","type":"link in","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["61901287.5cc6bc","f2e9482d.949c9","9192c4ac.87a6c","1634c03.308214","381474cb.f73ac4","fc75c09a.ff318","e27a796f.a5e7e8"],"x":1151.3876037597656,"y":411.71865463256836,"wires":[["a47d4454.d544e"]]},{"id":"61901287.5cc6bc","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["ade245d0.7b73d"],"x":1398.130313873291,"y":969.2993583679199,"wires":[]},{"id":"8cba0a67.42a0b8","type":"link out","z":"3fa7f249.e9d566","name":"Atualizacao dos 32 registradores  ModBus","links":["b9410cf8.14726","278b8d9f.332cc2","3292c332.e62afc","17d59d24.8682a3","fded0008.003bb8","91bb35aa.506f38","7a9f7416.07fd14","ffc2b971.50fa4","777bd47b.b983dc","a99b0250.54b63"],"x":2382.1453762054443,"y":461.03600120544434,"wires":[]},{"id":"f2e9482d.949c9","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["ade245d0.7b73d"],"x":1398.3387756347656,"y":1039.7139110565186,"wires":[]},{"id":"1297d514.9ad473","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1398.0293426513672,"y":1075.3329963684082,"wires":[]},{"id":"2afb58ae.609598","type":"link in","z":"3fa7f249.e9d566","name":"","links":["1297d514.9ad473","a255743e.0c3a48","2f02d021.a85c7","9b6c6b2e.a3902","d0a26883.48ac4","556c5c31.ced8a4","9e5fb3c7.ca9d58","97e5436.b16884","d620cd01.fbebe","af09c9c.9eea0b8","8eceed8e.d88a58","22e2dc05.1d0bec","9984763c.0e527","37bfc6d8.55496a","5113cabd.6496bc","726f645c.968ab4","5354645a.bd1734"],"x":3053.5848355293274,"y":1189.6385078430176,"wires":[["99f141c0.738eb8"]]},{"id":"a255743e.0c3a48","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1398.148380279541,"y":1004.5710639953613,"wires":[]},{"id":"2035530c.e0c28c","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["b9410cf8.14726"],"x":1399.1960754394531,"y":1109.221929550171,"wires":[]},{"id":"9b6c6b2e.a3902","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1399.4183044433594,"y":1143.221929550171,"wires":[]},{"id":"ffce9c75.a1ea5","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["b9410cf8.14726"],"x":1398.9294128417969,"y":1179.333013534546,"wires":[]},{"id":"d0a26883.48ac4","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1398.9294128417969,"y":1214.333013534546,"wires":[]},{"id":"96ef6800.4b4bd8","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Estado da Maquina","topic":"AplanadoraN/Estado","qos":"0","retain":"false","broker":"4d1bed4f.c5b27c","x":2592.330841064453,"y":495.0155258178711,"wires":[]},{"id":"7dc564c.cd80e1c","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Estado da Maquina","topic":"AplanadoraN/Estado","qos":"0","retain":"false","broker":"4d1bed4f.c5b27c","x":2444.4343910217285,"y":1044.7139401435852,"wires":[]},{"id":"7076e38b.aec82c","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Estado da Maquina","topic":"AplanadoraN/Estado","qos":"0","retain":"false","broker":"4d1bed4f.c5b27c","x":2446.286895751953,"y":1175.4281272888184,"wires":[]},{"id":"9de229f4.002cf","type":"function","z":"3fa7f249.e9d566","name":"Delay 100ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 100);\nreturn null;","outputs":1,"noerr":0,"x":2395.862663269043,"y":995.2853226661682,"wires":[["393af405.b4ee64"]]},{"id":"a47d4454.d544e","type":"function","z":"3fa7f249.e9d566","name":"Delay 500ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 500);\nreturn null;","outputs":1,"noerr":0,"x":1304.8625259399414,"y":484.0472369194031,"wires":[["c607ffcf.0fa448"]]},{"id":"8f14ac6.3c164d","type":"debug","z":"3fa7f249.e9d566","name":"Comandomaquina=0","active":true,"console":"false","complete":"payload","x":2422.386589050293,"y":892.9044733047485,"wires":[]},{"id":"2f02d021.a85c7","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":2756.7794227600098,"y":1001.3329339027405,"wires":[]},{"id":"df391f71.ea453","type":"switch","z":"3fa7f249.e9d566","name":"ComandoMaquina","property":"ComandoMaquina","propertyType":"global","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"eq","v":"4","vt":"str"},{"t":"eq","v":"5","vt":"str"},{"t":"eq","v":"6","vt":"str"},{"t":"eq","v":"7","vt":"str"},{"t":"eq","v":"8","vt":"str"},{"t":"eq","v":"9","vt":"str"},{"t":"eq","v":"10","vt":"str"},{"t":"eq","v":"11","vt":"str"}],"checkall":"true","outputs":12,"x":1851.3624572753906,"y":1170.7140159606934,"wires":[["33be9f4f.89e65"],["f9c4e8b0.40be08"],["e572aa9f.54956"],["a969a8b7.fc98c"],["aae8b961.b39f2"],["66b8df7d.ff6978"],["77930560.39332c"],["e5624514.eed6b8"],["b4b4e58d.186368"],["b492626e.396a98"],["f55e6946.427d9"],["2b941919.7bf436"]]},{"id":"9dc48c65.c1cf48","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2867.696159362793,"y":976.3805775642395,"wires":[[]]},{"id":"46b626ad.4f806","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2873.6244163513184,"y":1108.7615113258362,"wires":[[]]},{"id":"e572aa9f.54956","type":"function","z":"3fa7f249.e9d566","name":"Ligou motor?","func":"//verifica 3.3 e libera 2.12\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n\nif (((modbus[3]) & (1 << 3))) {//M3.3 igual a 1 ligando motor\n    modbus[2] |= (1<<12);\n    msg.payload = modbus[2];\n    msg2.payload ={ type: 'info', message: 'Acelerando motor...' };\n    msg2.payload.time= new Date();\n    node.status({fill:\"green\",shape:\"dot\",text:\"Acelerando...\"});\n}else if (~((modbus[3]) & (1 << 3))){ // M3.3 igual a 0 Desliga motor\n    modbus[2] &= ~(1<<12);\n    msg.payload = modbus[2];\n    msg2.payload ={ type: 'info', message: 'Desligando motor...' };\n    msg2.payload.time= new Date();\n    node.status({fill:\"yellow\",shape:\"ring\",text:\"Deslingado\"});\n}else {\n    node.status({fill:\"red\",shape:\"ring\",text:\"Bug\"});\n}\n    \nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2145.2626991271973,"y":1131.447313785553,"wires":[["c695fff0.96e71"],["7076e38b.aec82c"]]},{"id":"c695fff0.96e71","type":"function","z":"3fa7f249.e9d566","name":"Delay 100ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 100);\nreturn null;","outputs":1,"noerr":0,"x":2395.8624229431152,"y":1125.3805804252625,"wires":[["1118a93c.898ed7"]]},{"id":"1118a93c.898ed7","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Desliga motor M2.12","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":2605.5291786193848,"y":1125.0472893714905,"wires":[["46b626ad.4f806"],["556c5c31.ced8a4"]]},{"id":"556c5c31.ced8a4","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":2762.1483192443848,"y":1131.475878238678,"wires":[]},{"id":"63ad0bc7.fff9a4","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2876.3626747131348,"y":1229.7972893714905,"wires":[[]]},{"id":"a969a8b7.fc98c","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\" Aplanadora Abre M31.10\"});\nreturn null;","outputs":1,"noerr":0,"x":2145.6126747131348,"y":1234.7972893714905,"wires":[["63ad0bc7.fff9a4"]]},{"id":"3bb89730.fafe3","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2876.8626747131348,"y":1279.0472893714905,"wires":[[]]},{"id":"aae8b961.b39f2","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Aplanadora fecha M31.11\"});\nreturn null;","outputs":1,"noerr":0,"x":2144.1126747131348,"y":1282.7972893714905,"wires":[["3bb89730.fafe3"]]},{"id":"f8379be7.5fcec8","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["b9410cf8.14726"],"x":1399.7199058532715,"y":1249.4330649375916,"wires":[]},{"id":"9e5fb3c7.ca9d58","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1400.148494720459,"y":1284.147298336029,"wires":[]},{"id":"9853a9d6.613778","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["b9410cf8.14726"],"x":1400.7199058532715,"y":1320.290120601654,"wires":[]},{"id":"97e5436.b16884","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1400.005672454834,"y":1355.4330649375916,"wires":[]},{"id":"66b8df7d.ff6978","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\" Perfil Avança M2.3\"});\nreturn null;","outputs":1,"noerr":0,"x":2147.0055236816406,"y":1329.8615531921387,"wires":[["53afa128.a4db3"]]},{"id":"77930560.39332c","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"M2.4\"});\nreturn null;","outputs":1,"noerr":0,"x":2146.5055236816406,"y":1375.8615531921387,"wires":[["8c3566ed.de2"]]},{"id":"53afa128.a4db3","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2876.7198791503906,"y":1326.8615531921387,"wires":[[]]},{"id":"8c3566ed.de2","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2876.862579345703,"y":1372.8615446090698,"wires":[[]]},{"id":"d95decc6.b83198","type":"switch","z":"3fa7f249.e9d566","name":"i<7","property":"i","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"str"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"},{"t":"eq","v":"4","vt":"str"},{"t":"eq","v":"5","vt":"str"},{"t":"else"}],"checkall":"true","outputs":7,"x":1896.501552581787,"y":348.0916919708252,"wires":[["948cefa4.150d28"],["fef9f442.332898"],["3d250cea.f0872c"],["c04f7d60.5d264"],["9ca3ab0a.84ccf"],["eb085851.ec18b"],["93591ee9.8ef8d"]]},{"id":"d4c6f65a.55a18","type":"function","z":"3fa7f249.e9d566","name":"i++","func":"msg.i++;\n\nreturn msg;","outputs":1,"noerr":0,"x":2037.362449645996,"y":113.17501831054688,"wires":[["d95decc6.b83198"]]},{"id":"948cefa4.150d28","type":"function","z":"3fa7f249.e9d566","name":"ALARMES E MENSAGENS HTML","func":"var mensagens = global.get(\"mensagens\");\nvar modbus = msg.payload;\nvar msg2 ={\n    //_msgid: msg._msgid,\n    payload: msg.payload\n};\n\n//msg.payload = msg.i;\n\nif (msg2.payload[0] & (1 << 0)) {\n    msg2.payload = mensagens['EMERGENCIA'];\n} else if (msg2.payload[0] & (1 << 1)) {\n    msg2.payload = mensagens['FALTA_FASE'];\n} else if (msg2.payload[0] & (1 << 2)) {\n    msg2.payload = mensagens['BOMBA_HIDRAULICA'];\n} else if (msg2.payload[0] & (1 << 3)) {\n    msg2.payload = mensagens['MARTELO_PRENSA'];\n} else if (msg2.payload[0] & (1 << 4)) {\n    msg2.payload = mensagens['PRESSAO_AR'];\n} else if (msg2.payload[0] & (1 << 5)) {\n    msg2.payload = mensagens['INVERSOR'];\n} else if (msg2.payload[0] & (1 << 6))  {\n    msg2.payload = mensagens['SERVO'];\n} else if ((msg2.payload[0] & (1 << 7)))/*||(msg.payload[2] &= ~(1 << 11)))*/  {\n    msg2.payload = mensagens['CHAVE_GERAL_DESLIGADA'];\n} else if (msg2.payload[0] & (1 << 9))  {\n    msg2.payload = mensagens['ERRO_POSICIONAMENTO'];\n} else if (msg2.payload[0] & (1 << 10)) {\n    msg2.payload = mensagens['SEGURAN_PRENSA'];\n} else if (msg2.payload[1] & (1 << 12)) {\n    msg2.payload = mensagens['APLAN_ABERTA'];\n} else if (msg2.payload[0] & (1 << 8))  {\n    msg2.payload = mensagens['MAQUINA_NAO_LIBERADA'];\n} else {\n    if((global.get(\"MotorInvertido\"))==1){\n        msg2.payload = { type: 'info', message: ' Motor Invertido!!!'};\n    }else{\n        msg2.payload = { type: 'info', message: ' Maquina OK'};\n    }\n    \n}\n\n\nmsg2.payload.time= new Date();\nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2171.043071746826,"y":239.67504119873047,"wires":[["d4c6f65a.55a18"],["96ef6800.4b4bd8","cd73b421.a81c1"]]},{"id":"a38fd428.2ddb1","type":"function","z":"3fa7f249.e9d566","name":"loop leitura i=0","func":"global.set(\"ModBus\",msg.payload);\nmsg.i =0;\nreturn msg;","outputs":1,"noerr":0,"x":1718.8348007202148,"y":347.8972911834717,"wires":[["d95decc6.b83198"]]},{"id":"fef9f442.332898","type":"function","z":"3fa7f249.e9d566","name":"APLANADORA FECHADA HTML","func":"var msg2 ={\n    //_msgid: msg._msgid,\n    payload: global.get(\"ModBus\")\n};\n\n//msg.payload = msg.i;\n\nif (msg2.payload[1] & (1 << 12))  {\n        msg2= {\n            payload: { \n                APLANADORA_FECHADA:0\n            }\n        };\n    } else{\n        msg2= {\n            payload: {\n                APLANADORA_FECHADA:1\n            }\n        };\n    }\n\nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2171.1432876586914,"y":275.4696273803711,"wires":[["d4c6f65a.55a18"],["96ef6800.4b4bd8"]]},{"id":"3d250cea.f0872c","type":"function","z":"3fa7f249.e9d566","name":"ATUALIZA MAQ LIGADA HTML","func":"var msg2 ={\n    //_msgid: msg._msgid,\n    payload: global.get(\"ModBus\")\n};\n\n//msg.payload = msg.i;\nif (msg2.payload[2] & (1 << 11 )) {\n        msg2= {\n            payload: { \n                MAQUINA_ON:1\n            }\n        };\n    } else{\n        msg2= {\n            payload: {\n                MAQUINA_ON:0\n            }\n        };\n    }\n\nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2160.6402282714844,"y":312.7028112411499,"wires":[["d4c6f65a.55a18"],["96ef6800.4b4bd8"]]},{"id":"93591ee9.8ef8d","type":"function","z":"3fa7f249.e9d566","name":"Loop Finished","func":"msg.payload=global.get(\"ModBus\");\nreturn msg;","outputs":1,"noerr":0,"x":2110.973731994629,"y":460.9250464439392,"wires":[["ce7e132a.60d6c8"]]},{"id":"ce7e132a.60d6c8","type":"function","z":"3fa7f249.e9d566","name":"Delay 300ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 300);\nreturn null;","outputs":1,"noerr":0,"x":2279.2626571655273,"y":460.6806163787842,"wires":[["8cba0a67.42a0b8"]]},{"id":"a5197e14.c58748","type":"inject","z":"3fa7f249.e9d566","name":"Criar estrutura parametros","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":3495.329704284668,"y":1626.4639081954956,"wires":[["5302d42c.57576c"]]},{"id":"a182d9f7.850c38","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"store","x":3981.687301635742,"y":1625.9591274261475,"wires":[]},{"id":"483f884e.fb259","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nreturn null;","outputs":1,"noerr":0,"x":2277.2341690063477,"y":551.0234775543213,"wires":[["96ef6800.4b4bd8","e7682d84.44993"]]},{"id":"98ccd875.035cd8","type":"function","z":"3fa7f249.e9d566","name":"mudar 1 item apenas","func":"msg.query = { _id: 'AplanadoraN3' }\nmsg.payload = {\n    $set: {\n       \"parametros.encoder.fator\": 2225\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":3775.6407470703125,"y":1792.0362224578857,"wires":[["58bd1bd8.aac04c"]]},{"id":"58bd1bd8.aac04c","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"update only one","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"update","x":4011.6407318115234,"y":1792.4362163543701,"wires":[]},{"id":"4194ce3.b635c3","type":"inject","z":"3fa7f249.e9d566","name":"String vazia","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":3453.6735229492188,"y":1970.8805799484253,"wires":[["fa438731.4c428"]]},{"id":"b657a5d3.655e9","type":"mongodb in","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"consulta","collection":"parametros","operation":"find","x":3972.640693664551,"y":1971.2360763549805,"wires":[["22c4633d.f60a44"]]},{"id":"22c4633d.f60a44","type":"debug","z":"3fa7f249.e9d566","name":"resposta do MongoDB","active":true,"console":"false","complete":"payload","x":4256.751735687256,"y":1971.3472318649292,"wires":[]},{"id":"5302d42c.57576c","type":"function","z":"3fa7f249.e9d566","name":"collection inicial parametros","func":"msg.payload = {\n\t\"_id\": \"AplanadoraN3\",\n\t\"nome\": \"Aplanadora N3\",\n\t\"setor\": \"Estamparia\",\n\t\"parametros\": {\n\t\t\"encoder\": {\n\t\t\t\"fator\": 9999,\n\t\t\t\"resolucao\": 2500,\n\t\t\t\"perimetro\": 400\n\t\t},\n\t\t\"velocidade\": {\n\t\t\t\"automatico\": 95,\n\t\t\t\"manual\": 25\n\t\t},\n\t\t\"ferramenta\": {\n\t\t\t\"passo\": 200\n\t\t}\n\t},\n\t\"estado\": {\n\t\t\"situacao\": {\n\t\t\t\"codigo\": 99,\n\t\t\t\"descricao\": \"Maquina OK\"\n\t\t}\n\t},\n\t\"operador\": {\n\t\t\"codigo\": 1012,\n\t\t\"nome\": \"IRANILDO\"\n\t},\n\t\"os\": {\n\t    \"numero\": \"1231-11\",\n\t    \"produto\": {\n\t        \"codigo\": \"XXXXXXXXX\",\n\t        \"descricao\": \"AAAAAABBBBBCCCCC\"\n\t    },\n\t    \"quantidade\": 1550,\n\t    \"produzido\": 0,\n\t    \"refugo\": 0\n\t},\n\t\"lubrificacao\": {\n\t\t\"preset\": {\n\t\t        \"MbNovoCiclosUnd\":0,\n\t\t        \"MbNovoCiclosmil\":1\n\t\t},\n\t\t\"ciclos\": {\n\t\t        \"PrsCiclosUnid\":500,\n\t\t        \"PrsCiclosMil\":0\n\t\t}\n\t},\n\t\"timestamp\":new Date()\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":3774.6962890625,"y":1626.0639142990112,"wires":[["a182d9f7.850c38"]]},{"id":"4f400d21.4442ec","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"APAGAR TODA A COLLECTION log_erro","collection":"log_erro","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":3870.418212890625,"y":1507.2582473754883,"wires":[]},{"id":"a4dff8b7.e123","type":"inject","z":"3fa7f249.e9d566","name":"LIMPAR coleção log_erro","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":3495.171760559082,"y":1507.9853029251099,"wires":[["4f400d21.4442ec"]]},{"id":"c3b84537.499468","type":"inject","z":"3fa7f249.e9d566","name":"$set fator encoder","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":3474.4742851257324,"y":1791.7029190063477,"wires":[["98ccd875.035cd8"]]},{"id":"4c3f799b.d3ac28","type":"function","z":"3fa7f249.e9d566","name":"contador +1","func":"msg.query = { _id: 'AplanadoraN3' }\nmsg.payload = {\n    $inc: {\n       \"os.produzido\": 1\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":3774.86279296875,"y":1877.8138990402222,"wires":[["24fa71b8.720f56"]]},{"id":"24fa71b8.720f56","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"update","x":3982.862777709961,"y":1878.2138929367065,"wires":[]},{"id":"1256672f.ea0ee9","type":"inject","z":"3fa7f249.e9d566","name":"$inc: incrementa","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":3461.69633102417,"y":1877.480595588684,"wires":[["4c3f799b.d3ac28","505f382e.6abed"]]},{"id":"fa438731.4c428","type":"function","z":"3fa7f249.e9d566","name":"Paginação ","func":"msg.limit = 5;\nmsg.skip = 0;\nreturn msg;","outputs":1,"noerr":0,"x":3771.0850467681885,"y":1971.2953596115112,"wires":[["b657a5d3.655e9"]]},{"id":"5fa159c9.286b8","type":"comment","z":"3fa7f249.e9d566","name":"Paginação  e consulta MongoDB","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":3489.862880706787,"y":1935.1471991539001,"wires":[]},{"id":"af13594.092f0a8","type":"inject","z":"3fa7f249.e9d566","name":"Criar estrutura log_erro","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":3485.307144165039,"y":1664.56396484375,"wires":[["9adc0eca.456ce"]]},{"id":"cd51eeca.34c958","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"log_erro","payonly":true,"upsert":false,"multi":false,"operation":"store","x":3982.6650314331055,"y":1664.6147966384888,"wires":[]},{"id":"9adc0eca.456ce","type":"function","z":"3fa7f249.e9d566","name":"collection inicial log_erro","func":"msg.payload = {\n\t\"_id\": 1,\n\t\"log_mesagens\": {\n\t}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":3775.6740188598633,"y":1664.7195835113525,"wires":[["cd51eeca.34c958"]]},{"id":"702bbaf9.9ad724","type":"comment","z":"3fa7f249.e9d566","name":"Liga Chave Geral e Libera a Maquina","info":"#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso","x":2220.7515869140625,"y":959.7027988433838,"wires":[]},{"id":"ce6741ad.58967","type":"comment","z":"3fa7f249.e9d566","name":"Liga / Deslig Motor","info":"#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso","x":2164.4183654785156,"y":1089.7028465270996,"wires":[]},{"id":"e246e192.e9b81","type":"comment","z":"3fa7f249.e9d566","name":"Envia para fila qualquer erro na comunicação","info":"#test\n- nao\n- sei\n- onde v\n- vai \n- parar\n- isso","x":3267.1959533691406,"y":1151.7028465270996,"wires":[]},{"id":"fad9cce2.d9239","type":"mongodb in","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"consulta","collection":"parametros","operation":"find","x":3874.529401779175,"y":2051.7306032180786,"wires":[["c1319c39.8fbbd"]]},{"id":"62c3e64b.5d3ee","type":"function","z":"3fa7f249.e9d566","name":"lê apenas 1 parametro","func":"// Para ler um registro primeiro especificar \"_id\" no payload\nmsg.payload = { \"_id\": \"AplanadoraN3\" }\n\n// No parametro projection 1 ou zero significa ler ou inguinorar resultado\nmsg.projection = { \"parametros.encoder.fator\": 1 }\n\n// Ler 1 valor\nmsg.limit = 1;\n\n// Pular 0 resultados\nmsg.skip = 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":3661.6404724121094,"y":2051.567633628845,"wires":[["fad9cce2.d9239"]]},{"id":"3d118ce2.023c1c","type":"inject","z":"3fa7f249.e9d566","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":3441.6543827056885,"y":2051.2305841445923,"wires":[["62c3e64b.5d3ee"]]},{"id":"c1319c39.8fbbd","type":"function","z":"3fa7f249.e9d566","name":"parse(fator encoder)","func":"msg.payload=msg.payload[0].parametros.encoder.fator;\nreturn msg;","outputs":1,"noerr":0,"x":4067.6962184906006,"y":2052.1473026275635,"wires":[["eaf355d.9caba28"]]},{"id":"eaf355d.9caba28","type":"debug","z":"3fa7f249.e9d566","name":"ler registrador x","active":true,"console":"false","complete":"payload","x":4274.029638290405,"y":2052.147183418274,"wires":[]},{"id":"30c0b00c.11c998","type":"comment","z":"3fa7f249.e9d566","name":"Lê apenas um valor","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":3446.862434387207,"y":2016.1472434997559,"wires":[]},{"id":"505f382e.6abed","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nreturn null;","outputs":1,"noerr":0,"x":3774.1961975097656,"y":1913.258186340332,"wires":[["fa438731.4c428"]]},{"id":"3c296e63.3ad802","type":"comment","z":"3fa7f249.e9d566","name":"Contador Produzidos ++ ","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":3466.862373352051,"y":1842.1471557617188,"wires":[]},{"id":"1c1e21f.8d278de","type":"comment","z":"3fa7f249.e9d566","name":"Mudar apenas 1 registro do banco com $set","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":3529.6403045654297,"y":1753.4805526733398,"wires":[]},{"id":"958ccef4.f912a","type":"comment","z":"3fa7f249.e9d566","name":"2- Cria estrutura inicial das coleções","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":3500.195869445801,"y":1589.813889503479,"wires":[]},{"id":"44e70080.1eab78","type":"comment","z":"3fa7f249.e9d566","name":"1- Apagar Cuidado","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":3451.7512969970703,"y":1429.0360441207886,"wires":[]},{"id":"29db1be3.af3c04","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"APAGAR TODA A COLLECTION parametros","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":3861.8624572753906,"y":1470.036018371582,"wires":[]},{"id":"248c2e08.3d09d2","type":"inject","z":"3fa7f249.e9d566","name":"LIMPAR coleção parametros","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":3505.504608154297,"y":1469.985221862793,"wires":[["29db1be3.af3c04"]]},{"id":"a3855f8.40fa6a","type":"mongodb in","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"consulta","collection":"parametros","operation":"find","x":2740.496406555176,"y":610.391679763794,"wires":[["b90f4b09.a36c38","7f95d4ab.445024"]]},{"id":"e7682d84.44993","type":"function","z":"3fa7f249.e9d566","name":"Paginação ","func":"msg.limit = 5;\nmsg.skip = 0;\nreturn msg;","outputs":1,"noerr":0,"x":2540.6074771881104,"y":610.2287101745605,"wires":[["a3855f8.40fa6a","cdbbf740.506f3"]]},{"id":"e057bfd2.9cac3","type":"comment","z":"3fa7f249.e9d566","name":"Carrega valores iniciais do banco","info":"#Resultados de paginação usando skip e limit\n\nMuitas vezes, ao lidar com conjuntos de resultados de dados, \nsó queremos recuperar um subconjunto por vez, talvez para fornecer \nresultados por página da Web. Em MySQL, em geral fazemos isso \nusando a palavra-chave LIMIT. \nÉ fácil replicar essa funcionalidade no MongoDB \nusando msg.skip e msg.limit. \nPara retornar os primeiros cinco documentos na \ncoleção, podemos executar a seguinte operação:\n> msg.limit = 5;<\n\nPara pular resultados, use o seguinte comando:\n\n> msg.skip = 5;<\n\nCom ele é possível iguinorar os primeiros cinco\nregistros. ","x":2598.8853454589844,"y":575.3305625915527,"wires":[]},{"id":"b90f4b09.a36c38","type":"function","z":"3fa7f249.e9d566","name":"Carrega todos os parametros","func":"//Cria um array vazio\nvar parametros = [];\n\nparametros.push(msg.payload[0].parametros.velocidade.automatico);   //AplanVelAuto M14\nparametros.push(msg.payload[0].parametros.velocidade.manual);       //AplanVelMan M17\nparametros.push(msg.payload[0].parametros.ferramenta.passo);        //AplanPasso M18\nparametros.push(msg.payload[0].parametros.encoder.fator);           //EncFactor M20\nparametros.push(msg.payload[0].parametros.encoder.resolucao);       //EncResol M21 \nparametros.push(msg.payload[0].parametros.encoder.perimetro);       //EncPerim M22\nparametros.push(msg.payload[0].lubrificacao.ciclos.PrsCiclosUnid);  //PrsCiclosUnid M23\nparametros.push(msg.payload[0].lubrificacao.ciclos.PrsCiclosMil);   //PrsCiclosMil M24\nparametros.push(msg.payload[0].lubrificacao.preset.MbNovoCiclosUnd);//NovoPrsCiclosUnd M25\nparametros.push(msg.payload[0].lubrificacao.preset.MbNovoCiclosmil);//NovoCiclosMil M26\n\n//Salva em uma variavel externa ao bloco\nflow.set('params', parametros); \n\n//Envia o conteudo do array para o proximo bloco\nmsg.payload = parametros;\n\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Parametros Carregados\"});\nreturn msg;","outputs":"1","noerr":0,"x":2956.5516891479488,"y":610.0806293487547,"wires":[["fedd6b86.83aa6","c42e97bc.c7d3b8","7b0e8e0b.c9ed98"]]},{"id":"fedd6b86.83aa6","type":"debug","z":"3fa7f249.e9d566","name":"Array completo","active":true,"console":"false","complete":"payload","x":3232.670425415039,"y":752.8426990509033,"wires":[]},{"id":"c42e97bc.c7d3b8","type":"debug","z":"3fa7f249.e9d566","name":"tamanho","active":false,"console":"false","complete":"payload.length","x":3210.337242126465,"y":712.3185348510742,"wires":[]},{"id":"7b0e8e0b.c9ed98","type":"function","z":"3fa7f249.e9d566","name":"Separa cada mensagem","func":"var msgs = [null, null, null, null, null, null, null, null, null, null];\n\nmsgs[flow.get('params').length - 1] = {payload: flow.get('params')[flow.get('params').length - 1]};\n\nnode.send(msgs);\n","outputs":"10","noerr":0,"x":3257.2985229492188,"y":611.1630821228027,"wires":[["58299d1f.022bf4","1a14dac7.440c7d"],["e39c4998.c87d98"],["4423f7fd.67006"],["9ca64c94.903cc"],["b1f1454.f9679b8"],["c4d16cc4.a8b63"],["87c98bfc.7f673"],["8caef598.14b1"],["3271d905.5a2e46"],["ef59e1e4.0da438"]]},{"id":"d620cd01.fbebe","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":3804.9891662597656,"y":897.766414642334,"wires":[]},{"id":"612d7895.1ec3b","type":"function","z":"3fa7f249.e9d566","name":"LOOP DE ESCRITA","func":"//Somente entra aqui se o array ainda for >= 0\nif (flow.get('params').length >= 0) {\n    \n    // Carrega todos os parametros que ainda não foram enviados\n    var params = flow.get('params');\n    \n    // Cria um novo Array tirando o ultimo elemento\n    var novo = params.slice(0, flow.get('params').length - 1);\n    \n    // Sobrescreve o arry params\n    flow.set('params', novo);\n    \n    // Envia novo array com -1 elemento\n    msg.payload = novo;\n    return msg;\n}\n","outputs":1,"noerr":0,"x":3249.6246643066406,"y":420.48061752319336,"wires":[["7b0e8e0b.c9ed98"]]},{"id":"d09147d.d46af38","type":"debug","z":"3fa7f249.e9d566","name":"LOOP","active":true,"console":"false","complete":"payload","x":3199.0848693847656,"y":462.36950302124023,"wires":[]},{"id":"58299d1f.022bf4","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"AplanVelAuto_M14","dataType":"HoldingRegister","adr":"14","server":"b07224c0.b4a83","x":3579.0849227905273,"y":421.98053646087646,"wires":[["a748adb.306c7d","4a70a1a.90ebe6"],["d620cd01.fbebe"]]},{"id":"b1f1454.f9679b8","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"EncResol_M21","dataType":"HoldingRegister","adr":"21","server":"b07224c0.b4a83","x":3570.6563835144043,"y":614.409122467041,"wires":[["a748adb.306c7d","7a448c2d.15a7f4"],["d620cd01.fbebe"]]},{"id":"4423f7fd.67006","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"AplanPasso_M18","dataType":"HoldingRegister","adr":"18","server":"b07224c0.b4a83","x":3581.2276000976562,"y":519.1234750747681,"wires":[["a748adb.306c7d","a4d7b9c1.95dbf8"],["d620cd01.fbebe"]]},{"id":"e39c4998.c87d98","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"AplanVelMan_M17","dataType":"HoldingRegister","adr":"17","server":"b07224c0.b4a83","x":3580.3705444335938,"y":470.12347507476807,"wires":[["a748adb.306c7d","cc72ddb9.228e78"],["d620cd01.fbebe"]]},{"id":"9ca64c94.903cc","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"EncFactor_M20","dataType":"HoldingRegister","adr":"20","server":"b07224c0.b4a83","x":3570.2276725769043,"y":567.8377113342285,"wires":[["a748adb.306c7d","d6f3462c.46f66"],["d620cd01.fbebe"]]},{"id":"ef59e1e4.0da438","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"NovoCiclosMil_M26","dataType":"HoldingRegister","adr":"26","server":"b07224c0.b4a83","x":3591.0848503112793,"y":856.9805335998535,"wires":[["a748adb.306c7d","2409fb17.3b5704"],["d620cd01.fbebe"]]},{"id":"87c98bfc.7f673","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"PrsCiclosUnid_M27","dataType":"HoldingRegister","adr":"27","server":"b07224c0.b4a83","x":3581.6560668945312,"y":715.6948862075806,"wires":[["a748adb.306c7d","59e5e04.b512fa"],["d620cd01.fbebe"]]},{"id":"c4d16cc4.a8b63","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"EncPerim_M22","dataType":"HoldingRegister","adr":"22","server":"b07224c0.b4a83","x":3570.7990112304688,"y":664.6948862075806,"wires":[["a748adb.306c7d","80bebfd5.fcc968"],["d620cd01.fbebe"]]},{"id":"3271d905.5a2e46","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"NovoPrsCiclosUnd_M25","dataType":"HoldingRegister","adr":"25","server":"b07224c0.b4a83","x":3600.6561393737793,"y":807.409122467041,"wires":[["a748adb.306c7d","914f21dd.86a0c"],["d620cd01.fbebe"]]},{"id":"8caef598.14b1","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"PrsCiclosMil_M28","dataType":"HoldingRegister","adr":"28","server":"b07224c0.b4a83","x":3581.8627014160156,"y":761.4806175231934,"wires":[["a748adb.306c7d","85b1aa.a581b658"],["d620cd01.fbebe"]]},{"id":"cc84da62.00775","type":"link in","z":"3fa7f249.e9d566","name":"loop escrita","links":["a748adb.306c7d"],"x":2905.3627014160156,"y":420.44729232788086,"wires":[["6db1220b.2ada04"]]},{"id":"a748adb.306c7d","type":"link out","z":"3fa7f249.e9d566","name":"loop inicializando CLP","links":["cc84da62.00775"],"x":3814.3627014160156,"y":382.7472801208496,"wires":[]},{"id":"6db1220b.2ada04","type":"function","z":"3fa7f249.e9d566","name":"Delay 100ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 100);\nreturn null;","outputs":1,"noerr":0,"x":3011.3627014160156,"y":420.3973045349121,"wires":[["d09147d.d46af38","612d7895.1ec3b"]]},{"id":"f83acef6.644f9","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Regitradores da Maquina","topic":"AplanadoraN/registradores","qos":"0","retain":"false","broker":"4d1bed4f.c5b27c","x":4417.339111328125,"y":615.0996017456055,"wires":[]},{"id":"837cdd95.45cd4","type":"http response","z":"3fa7f249.e9d566","name":"","x":4151.862701416016,"y":2303.147304534912,"wires":[]},{"id":"61efeaa.dbc7a14","type":"http in","z":"3fa7f249.e9d566","name":"Index","url":"/","method":"get","swaggerDoc":"","x":3405.3070589701333,"y":2304.258366478814,"wires":[["c9535423.143a98"]]},{"id":"c9535423.143a98","type":"file in","z":"3fa7f249.e9d566","name":"index.HTML","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/index.html","format":"utf8","x":3679.4181747436523,"y":2304.3694791793823,"wires":[["cdd9ee1a.9c3ff8"]]},{"id":"57c7591b.494678","type":"http response","z":"3fa7f249.e9d566","name":"","x":4156.307187398275,"y":2375.813953399658,"wires":[]},{"id":"a8f45d15.734c98","type":"http in","z":"3fa7f249.e9d566","name":"css/hmi.min.css","url":"/css/hmi.min.css","method":"get","swaggerDoc":"","x":3435.7515449523926,"y":2375.92501534356,"wires":[["e233887b.418f9"]]},{"id":"e233887b.418f9","type":"file in","z":"3fa7f249.e9d566","name":"hmi.min","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/css/hmi.min.css","format":"utf8","x":3670.5292930603027,"y":2375.8138847351074,"wires":[["b1b8d1e3.c0b368"]]},{"id":"b1b8d1e3.c0b368","type":"function","z":"3fa7f249.e9d566","name":"Text/CSS","func":"msg.headers = { \"Content-type\" : \"text/css\" }\n         \nreturn msg;","outputs":1,"noerr":0,"x":4016.8625984191895,"y":2375.7028064727783,"wires":[["57c7591b.494678"]]},{"id":"f916b570.5fd4d8","type":"comment","z":"3fa7f249.e9d566","name":"HTML","info":"","x":3404.8626861572266,"y":2268.14727973938,"wires":[]},{"id":"571e43dd.bf03d4","type":"comment","z":"3fa7f249.e9d566","name":"CSS","info":"","x":3405.7514991760254,"y":2340.258539199829,"wires":[]},{"id":"15c99985.8ba996","type":"comment","z":"3fa7f249.e9d566","name":"JAVASCRIPT","info":"","x":3425.195999145508,"y":2414.7030534744263,"wires":[]},{"id":"cf0d72e.b5a5d9","type":"http response","z":"3fa7f249.e9d566","name":"","x":4156.307149251303,"y":2450.258373260498,"wires":[]},{"id":"2bee15c9.b39652","type":"http in","z":"3fa7f249.e9d566","name":"jquery.js","url":"/js/jquery.js","method":"get","swaggerDoc":"","x":3415.75150680542,"y":2451.3694352044,"wires":[["e69fe357.3b8808"]]},{"id":"e69fe357.3b8808","type":"file in","z":"3fa7f249.e9d566","name":"jquery.js","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/js/jquery.js","format":"utf8","x":3670.52925491333,"y":2451.2583045959473,"wires":[["cf0d72e.b5a5d9"]]},{"id":"d6db4cd1.1fb958","type":"http response","z":"3fa7f249.e9d566","name":"","x":4156.751607259115,"y":2487.369487762451,"wires":[]},{"id":"73491938.c06a18","type":"http in","z":"3fa7f249.e9d566","name":"jquery-ui.js","url":"/js/jquery-ui.js","method":"get","swaggerDoc":"","x":3416.1959648132324,"y":2488.480549706353,"wires":[["260c0551.c4e9f2"]]},{"id":"260c0551.c4e9f2","type":"file in","z":"3fa7f249.e9d566","name":"jquery-ui.js","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/js/jquery-ui.js","format":"utf8","x":3680.9737129211426,"y":2488.3694190979004,"wires":[["d6db4cd1.1fb958"]]},{"id":"92f59e72.a30fd8","type":"http response","z":"3fa7f249.e9d566","name":"","x":4156.751607259115,"y":2523.8139457702637,"wires":[]},{"id":"99175c94.8fb7c","type":"http in","z":"3fa7f249.e9d566","name":"jquery.keyboard.js","url":"/js/jquery.keyboard.js","method":"get","swaggerDoc":"","x":3446.1959648132324,"y":2524.9250077141655,"wires":[["cb1b5b4b.70ba8"]]},{"id":"cb1b5b4b.70ba8","type":"file in","z":"3fa7f249.e9d566","name":"jquery.keyboard.js","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/js/jquery.keyboard.js","format":"utf8","x":3700.9737129211426,"y":2524.813877105713,"wires":[["92f59e72.a30fd8"]]},{"id":"64cdfdce.c55c24","type":"http response","z":"3fa7f249.e9d566","name":"","x":4157.196065266928,"y":2560.925060272217,"wires":[]},{"id":"33f907f9.250da","type":"http in","z":"3fa7f249.e9d566","name":"jquery.mousewheel.js","url":"/js/jquery.mousewheel.js","method":"get","swaggerDoc":"","x":3456.640422821045,"y":2562.0361222161187,"wires":[["8a23c5f6.1b803"]]},{"id":"8a23c5f6.1b803","type":"file in","z":"3fa7f249.e9d566","name":"jquery.mousewheel.js","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/js/jquery.mousewheel.js","format":"utf8","x":3711.418170928955,"y":2561.924991607666,"wires":[["64cdfdce.c55c24"]]},{"id":"5b46bc72.c4979c","type":"http response","z":"3fa7f249.e9d566","name":"","x":4157.5293858846035,"y":2596.925060272217,"wires":[]},{"id":"d602ff6e.20842","type":"http in","z":"3fa7f249.e9d566","name":"hmi.min.js","url":"/js/hmi.min.js","method":"get","swaggerDoc":"","x":3416.9737434387207,"y":2598.0361222161187,"wires":[["c61d3748.c9fb48"]]},{"id":"c61d3748.c9fb48","type":"file in","z":"3fa7f249.e9d566","name":"hmi.min.js","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/js/hmi.min.js","format":"utf8","x":3671.751491546631,"y":2597.924991607666,"wires":[["5b46bc72.c4979c"]]},{"id":"c4e8b6f6.6fe348","type":"comment","z":"3fa7f249.e9d566","name":"FONTS","info":"","x":3407.1959075927734,"y":2635.8137645721436,"wires":[]},{"id":"63909c33.a0cd1c","type":"http response","z":"3fa7f249.e9d566","name":"","x":4157.751607259115,"y":2671.147289276123,"wires":[]},{"id":"2d4122d5.f1b66e","type":"http in","z":"3fa7f249.e9d566","name":"fontawesome-webfont.woff","url":"/fonts/fontawesome-webfont.woff","method":"get","swaggerDoc":"","x":3467.1959648132324,"y":2671.258351220025,"wires":[["e1ca7c6b.f19f7"]]},{"id":"e1ca7c6b.f19f7","type":"file in","z":"3fa7f249.e9d566","name":"fontawesome-webfont.woff","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/fonts/fontawesome-webfont.woff","format":"","x":3731.9737129211426,"y":2671.1472206115723,"wires":[["bd0659a7.4343b8"]]},{"id":"ecbadbc.ec65628","type":"http response","z":"3fa7f249.e9d566","name":"","x":4158.196065266928,"y":2708.258403778076,"wires":[]},{"id":"632002de.bc4f1c","type":"http in","z":"3fa7f249.e9d566","name":"fontawesome-webfont.ttf","url":"/fonts/fontawesome-webfont.ttf","method":"get","swaggerDoc":"","x":3467.640422821045,"y":2708.369465721978,"wires":[["7a9da19e.a78ba"]]},{"id":"7a9da19e.a78ba","type":"file in","z":"3fa7f249.e9d566","name":"fontawesome-webfont.ttf","filename":"C:/Desenvolvimento/git/HMI-controler-with-node-red/gulp/fonts/fontawesome-webfont.ttf","format":"","x":3722.418170928955,"y":2708.2583351135254,"wires":[["fe4bb1b0.59ff18"]]},{"id":"bd0659a7.4343b8","type":"function","z":"3fa7f249.e9d566","name":"webfont.woff","func":"msg.headers = { \"Content-type\" : \"application/font-webfont.woff\" }\n         \nreturn msg;","outputs":1,"noerr":0,"x":4008.9737586975098,"y":2671.0361766815186,"wires":[["63909c33.a0cd1c"]]},{"id":"fe4bb1b0.59ff18","type":"function","z":"3fa7f249.e9d566","name":"webfont.ttf","func":"msg.headers = { \"Content-type\" : \"application/font-webfont.ttf\" }\n         \nreturn msg;","outputs":1,"noerr":0,"x":4009.862651824951,"y":2708.7028312683105,"wires":[["ecbadbc.ec65628"]]},{"id":"70405e1d.caedc8","type":"http response","z":"3fa7f249.e9d566","name":"","x":4241.084964752197,"y":2787.2583923339844,"wires":[]},{"id":"96a6e28d.404ae8","type":"http in","z":"3fa7f249.e9d566","name":"Image Files","url":"/images/:file","method":"get","swaggerDoc":"","x":3429.4181938171387,"y":2788.480580223931,"wires":[["34ae47a2.424c5"]]},{"id":"36243b15.ac6bd4","type":"file in","z":"3fa7f249.e9d566","name":"","filename":"","format":"","x":3876.418182373047,"y":2788.369415283203,"wires":[["e5b024c0.ec55a8","f7711dd1.099a1"]]},{"id":"e5b024c0.ec55a8","type":"function","z":"3fa7f249.e9d566","name":"msg type","func":"msg.headers = { \"Content-type\" : \"image/png\" }\n\nreturn msg;","outputs":1,"noerr":0,"x":4061.7515754699707,"y":2787.7027702331543,"wires":[["70405e1d.caedc8"]]},{"id":"38da91fb.aa60fe","type":"comment","z":"3fa7f249.e9d566","name":"IMAGENS E ARQUIVOS","info":"","x":3466.640106201172,"y":2744.7025470733643,"wires":[]},{"id":"34ae47a2.424c5","type":"function","z":"3fa7f249.e9d566","name":"files","func":"msg.filename = 'C:\\\\Desenvolvimento\\\\git\\\\HMI-controler-with-node-red\\\\gulp\\\\images\\\\' + msg.req.params.file;\n\nreturn msg;","outputs":1,"noerr":0,"x":3662.6405029296875,"y":2789.0360431671143,"wires":[["36243b15.ac6bd4"]]},{"id":"f7711dd1.099a1","type":"debug","z":"3fa7f249.e9d566","name":"","active":false,"console":"false","complete":"filename","x":4071.30708694458,"y":2834.1472454071045,"wires":[]},{"id":"f4889a7a.0eb528","type":"comment","z":"3fa7f249.e9d566","name":"Grava valor dos registradores no CLP","info":"A cada inicialização os valores dos registradores são atualizados a partir de MongoDB:\n\n1- AplanVelAuto M14\nVelocidade maxima no automatico de 0% a 100%\n\n2- AplanVelMan M17\nVelocidade maxima no manual de 0% a 100%\n\n3- AplanPasso M18\nPasso da ferramenta em \"mm\", de 0 a 400mm\n\n4- EncFactor M20\nFator de correção do encoder em numeros inteiros apenas.\n\n5- EncResol M21\nResolução do encoder em numeros inteiros apenas. 1 a 10000\n\n6- EncPerim M22\nPerimetro do encoder em \"mm\". De 1 a 999\n\n7- PrsCiclosUnid M23\nCiclos de Lubrificação da prensa. De 0 a 65534 unidades\n\n8- PrsCiclosMil M24\nCiclos de Lubrificação da prensa vezes 1000. De 0 a 65534 unidades\n\n9- NovoPrsCiclosUnd M25\nCiclos que faltam para proxima Lubrificação da prensa. De 0 a 65534 unidades\n\n10- NovoCiclosMil M26\nCiclos que faltam para proxima Lubrificação da prensa vezes 1000. De 0 a 65534 unidades\n\n","x":3584.5292053222656,"y":382.81396102905273,"wires":[]},{"id":"4a70a1a.90ebe6","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M14 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    AplanVelAuto: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n\n    \nreturn msg;","outputs":"1","noerr":0,"x":3962.862533569336,"y":421.71874809265137,"wires":[["f83acef6.644f9"]]},{"id":"cc72ddb9.228e78","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M17 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    AplanVelMan: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n    \nreturn msg;","outputs":"1","noerr":0,"x":3961.7198791503906,"y":470.29015731811523,"wires":[["f83acef6.644f9"]]},{"id":"d6f3462c.46f66","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M20 na pagina","func":"var valor = msg.payload;\n\nglobal.set(\"FatorEncoder\",valor);\nmsg.payload = {\n    EncFactor: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n    \nreturn msg;","outputs":"1","noerr":0,"x":3960.7198791503906,"y":568.0044822692871,"wires":[["f83acef6.644f9"]]},{"id":"a4d7b9c1.95dbf8","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M18 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    AplanPasso: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\nreturn msg;","outputs":"1","noerr":0,"x":3961.862533569336,"y":518.4330730438232,"wires":[["f83acef6.644f9"]]},{"id":"59e5e04.b512fa","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M27 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    PrsCiclosUnid: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n    \nreturn msg;","outputs":"1","noerr":0,"x":3959.5770568847656,"y":714.1473045349121,"wires":[["f83acef6.644f9"]]},{"id":"80bebfd5.fcc968","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M22 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    EncPerim: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\nreturn msg;","outputs":"1","noerr":0,"x":3960.719711303711,"y":664.5758953094482,"wires":[["f83acef6.644f9"]]},{"id":"7a448c2d.15a7f4","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M21 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    EncResol: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\nreturn msg;","outputs":"1","noerr":0,"x":3960.5770568847656,"y":616.4329795837402,"wires":[["f83acef6.644f9"]]},{"id":"2409fb17.3b5704","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M26 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    NovoCiclosMil: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:\"falta implementar\"});\n    \nreturn msg;","outputs":"1","noerr":0,"x":3958.7198791503906,"y":858.0044822692871,"wires":[["f83acef6.644f9"]]},{"id":"914f21dd.86a0c","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M25 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    NovoPrsCiclosUnd: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:valor});\n    \nreturn msg;","outputs":"1","noerr":0,"x":3959.862533569336,"y":808.4330730438232,"wires":[["f83acef6.644f9"]]},{"id":"85b1aa.a581b658","type":"function","z":"3fa7f249.e9d566","name":"Atualiza M28 na pagina","func":"var valor = msg.payload;\n\nmsg.payload = {\n    PrsCiclosMil: valor\n};\nnode.status({fill:\"blue\",shape:\"dot\",text:(\"Valor x1000 = \"+ valor)});\n\nreturn msg;","outputs":"1","noerr":0,"x":3959.7198791503906,"y":760.2901573181152,"wires":[["f83acef6.644f9"]]},{"id":"7f95d4ab.445024","type":"debug","z":"3fa7f249.e9d566","name":"consulta","active":false,"console":"false","complete":"payload","x":2897.9342346191406,"y":566.2188453674316,"wires":[]},{"id":"ad754542.d3c74","type":"function","z":"3fa7f249.e9d566","name":"Atualiza MongoDB","func":"var parametro = JSON.parse(msg.payload);\n\n/****** APLANADORA VELOCIDADE AUTOMATICA M14 *********/\nif (parametro.AplanVelAuto_KEYBOARD !== undefined) {\n    var x = parametro.AplanVelAuto_KEYBOARD;\n    msg.query = { _id: 'AplanadoraN3' }\n    msg.payload = {\n         $set: {\n         \"parametros.velocidade.automatico\": x\n        }\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Velocidade Auto = \"+ x)});\n    return msg;\n}\n\n/****** APLANADORA VELOCIDADE MANUAL M17 *********/\nif (parametro.AplanVelMan_KEYBOARD !== undefined) {\n    var x = parametro.AplanVelMan_KEYBOARD;\n    msg.query = { _id: 'AplanadoraN3' }\n    msg.payload = {\n         $set: {\n         \"parametros.velocidade.manual\": x\n        }\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Velocidade Manual = \"+ x)});\n    return msg;\n}\n\n/****** APLANADORA PASSO M18 *********/\nif (parametro.AplanPasso_KEYBOARD !== undefined) {\n    var x = parametro.AplanPasso_KEYBOARD;\n    msg.query = { _id: 'AplanadoraN3' }\n    msg.payload = {\n         $set: {\n         \"parametros.ferramenta.passo\": x\n        }\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Passo = \"+ x)});\n    return msg;\n}\n\n/****** FATOR DE ENCONDER M20*********/\nif (parametro.EncFactor_KEYBOARD !== undefined) {\n    var x = parametro.EncFactor_KEYBOARD;\n    msg.query = { _id: 'AplanadoraN3' }\n    msg.payload = {\n         $set: {\n         \"parametros.encoder.fator\": x\n        }\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"fator = \"+ x)});\n    return msg;\n}\n\n/****** RESOLUÇÃO DO ENCONDER M21 *********/\nif (parametro.EncResol_KEYBOARD !== undefined) {\n    var x = parametro.EncResol_KEYBOARD;\n    msg.query = { _id: 'AplanadoraN3' }\n    msg.payload = {\n         $set: {\n         \"parametros.encoder.resolucao\": x\n        }\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Resolução ENC = \"+ x)});\n    return msg;\n}\n\n/****** PERIMETRO DO ENCONDER M22 *********/\nif (parametro.EncPerim_KEYBOARD !== undefined) {\n    var x = parametro.EncPerim_KEYBOARD;\n    msg.query = { _id: 'AplanadoraN3' }\n    msg.payload = {\n         $set: {\n         \"parametros.encoder.perimetro\": x\n        }\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Perimetro ENC = \"+ x)});\n    return msg;\n}\n\n/****** TamanhoDesejadoPeca Campo da pagina *********/\nif (parametro.TamanhoDesejadoPeca_KEYBOARD !== undefined) {\n    var x = (parametro.TamanhoDesejadoPeca_KEYBOARD||0);\n    if ((x>=2)&&(x<=20000)){\n        global.set('TamanhoDesejadoPeca_KEYBOARD', x);\n    }else {\n        x=0;\n        global.set('TamanhoDesejadoPeca_KEYBOARD', 0);\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Tamanho Desejado = \"+ x)});\n}\n\n/****** TamanhoRealPeca Campo da pagina *********/\nif (parametro.TamanhoRealPeca_KEYBOARD !== undefined) {\n    var x = (parametro.TamanhoRealPeca_KEYBOARD||0);\n    if ((x>=2)&&(x<=20000)){\n        global.set('TamanhoRealPeca_KEYBOARD', x);\n    }else {\n        x=0;\n        global.set('TamanhoRealPeca_KEYBOARD', 0);\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Tamanho Real = \"+ x)});\n}\n\n/****** RecalcularFator e grava no banco *********/\nif (parametro.RecalcularFator !== undefined) {\n    var x = (global.get('TamanhoRealPeca_KEYBOARD')||0);\n    var y = (global.get('TamanhoDesejadoPeca_KEYBOARD')||0);\n    if ((x!==0)&&(y!==0)){\n        var z = x/y;\n        z *= (global.get('FatorEncoder')/10000);\n        var z2 = Math.round(z*10000);\n        msg.query = { _id: 'AplanadoraN3' }\n        msg.payload = {\n             $set: {\n             \"parametros.encoder.fator\": z2\n            }\n        }\n        node.status({fill:\"blue\",shape:\"dot\",text:(\"Calculado Fator ENC = \"+ z2)});\n        return msg;\n    }\n}\n\n/****** Atualiza numero de cilcos da prensa e grava no banco ********/\nif ((parametro.PrsCiclosUnid_KEYBOARD !== undefined )||(parametro.PRENSA_CICLOS !== undefined) ) {\n    msg.query = { _id: 'AplanadoraN3' }\n    msg.payload = {\n         $set: {\n         \"lubrificacao.ciclos.PrsCiclosUnid\": parametro.PrsCiclosUnid_KEYBOARD\n        }\n    }\n    node.status({fill:\"blue\",shape:\"dot\",text:(\"Ciclos = \"+ parametro.PrsCiclosUnid_KEYBOARD)});\n    return msg;\n}\n\n/* FALTA FAZER*************\nPrsCiclosUnid M23\nPrsCiclosMil M24\nNovoPrsCiclosUnd M25\nNovoCiclosMil M26*/\n\n\n","outputs":1,"noerr":0,"x":1999.2195472717285,"y":666.504430770874,"wires":[["82c7ede4.4615c","9cdee139.66853","d8337377.c368a8"]]},{"id":"82c7ede4.4615c","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"parametros","payonly":true,"upsert":false,"multi":false,"operation":"update","x":2261.219512939453,"y":666.5711011886597,"wires":[]},{"id":"3682f623.c4347a","type":"mqtt in","z":"3fa7f249.e9d566","name":"","topic":"AplanadoraN/registradores","qos":"0","broker":"83fa336e.ce02e8","x":1728.3153266906738,"y":716.7820262908936,"wires":[["ad754542.d3c74","c103e3f1.ac984"]]},{"id":"a366dec6.5b58e","type":"comment","z":"3fa7f249.e9d566","name":"Save the modified values in the bank","info":"#Whats is saved until now!\n\nAfter one JSON.parse(msg.payload);\n\nAPLANADORA VELOCIDADE AUTOMATICA M14\nAPLANADORA VELOCIDADE MANUAL M17\nAPLANADORA PASSO M18\nRESOLUÇÃO DO ENCONDER M21","x":2003.3826599121094,"y":625.9131679534912,"wires":[]},{"id":"9cdee139.66853","type":"debug","z":"3fa7f249.e9d566","name":"Salvou","active":true,"console":"false","complete":"payload","x":2260.6483459472656,"y":719.504451751709,"wires":[]},{"id":"d8337377.c368a8","type":"function","z":"3fa7f249.e9d566","name":"Delay 300ms","func":"setTimeout(function() {\n    msg= {payload: \"{MAQUINA_OFF:0}\"};\n    node.send(msg);\n}, 300);\n\nreturn null;","outputs":1,"noerr":0,"x":2277.6723022460938,"y":609.0282859802246,"wires":[["a523e196.5fa9e","e7682d84.44993"]]},{"id":"a523e196.5fa9e","type":"debug","z":"3fa7f249.e9d566","name":"depois de salvar","active":false,"console":"false","complete":"true","x":2539.415557861328,"y":668.6738243103027,"wires":[]},{"id":"c103e3f1.ac984","type":"debug","z":"3fa7f249.e9d566","name":"fila","active":false,"console":"false","complete":"payload","x":1959.6853141784668,"y":716.3881511688232,"wires":[]},{"id":"cdd9ee1a.9c3ff8","type":"function","z":"3fa7f249.e9d566","name":"Text/HTML","func":"msg.headers = { \"Content-type\" : \"text/html\" }\n\nreturn msg;","outputs":1,"noerr":0,"x":4003.6959533691406,"y":2303.1684532165527,"wires":[["837cdd95.45cd4"]]},{"id":"f92d1410.45319","type":"http response","z":"3fa7f249.e9d566","name":"","x":4242.796051025391,"y":2877.147304534912,"wires":[]},{"id":"1be6e0d1.7386bf","type":"http in","z":"3fa7f249.e9d566","name":"Image Files","url":"/css/images/:file","method":"get","swaggerDoc":"","x":3431.129280090332,"y":2877.369492424859,"wires":[["8eb61dd0.c62f9"]]},{"id":"c8e0567b.85abc8","type":"file in","z":"3fa7f249.e9d566","name":"","filename":"","format":"","x":3878.1292686462402,"y":2877.258327484131,"wires":[["178cf992.b25a3e","2e4656ea.1cb9aa"]]},{"id":"178cf992.b25a3e","type":"function","z":"3fa7f249.e9d566","name":"msg type","func":"msg.headers = { \"Content-type\" : \"image/png\" }\n\nreturn msg;","outputs":1,"noerr":0,"x":4063.462661743164,"y":2877.591682434082,"wires":[["f92d1410.45319"]]},{"id":"8eb61dd0.c62f9","type":"function","z":"3fa7f249.e9d566","name":"files","func":"msg.filename = 'C:\\\\Desenvolvimento\\\\git\\\\HMI-controler-with-node-red\\\\gulp\\\\css\\\\images\\\\' + msg.req.params.file;\n\nreturn msg;","outputs":1,"noerr":0,"x":3664.351589202881,"y":2877.924955368042,"wires":[["c8e0567b.85abc8"]]},{"id":"2e4656ea.1cb9aa","type":"debug","z":"3fa7f249.e9d566","name":"","active":false,"console":"false","complete":"filename","x":4073.0181732177734,"y":2923.036157608032,"wires":[]},{"id":"37014511.e596f2","type":"debug","z":"3fa7f249.e9d566","name":"board/setup","active":true,"console":"false","complete":"payload","x":808.5055503845215,"y":1220.218689441681,"wires":[]},{"id":"22993306.c46814","type":"debug","z":"3fa7f249.e9d566","name":"Leitura PLC","active":false,"console":"false","complete":"payload","x":1708.6483459472656,"y":419.9330406188965,"wires":[]},{"id":"571ee897.4e76a","type":"debug","z":"3fa7f249.e9d566","name":"loop6","active":false,"console":"false","complete":"true","x":2825.9896697998047,"y":308.0417242050171,"wires":[]},{"id":"c04f7d60.5d264","type":"function","z":"3fa7f249.e9d566","name":"ATUALIZA MAQ ERRO POS HTML","func":"//M19\nvar msg2 ={ payload: global.get(\"ModBus\")};\n\nmsg2 = {\n    payload: {\n        ERRO_POS: msg2.payload[19] \n    }\n};\n\n    \nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2170.8627014160156,"y":348.263973236084,"wires":[["d4c6f65a.55a18"],["96ef6800.4b4bd8"]]},{"id":"9ca3ab0a.84ccf","type":"function","z":"3fa7f249.e9d566","name":"ATUALIZA MAQ POS ATUAL HTML","func":"//M5\nvar msg2 ={ payload: global.get(\"ModBus\")};\n\nmsg2= {\n    payload:{\n        POS_ATUAL: msg2.payload[5] \n    \n}};\n\n    \nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2179.8627014160156,"y":386.263973236084,"wires":[["d4c6f65a.55a18"],["96ef6800.4b4bd8"]]},{"id":"eb085851.ec18b","type":"function","z":"3fa7f249.e9d566","name":"ATUALIZA MAQ","func":"//M5\nvar msg2 ={ payload: global.get(\"ModBus\")};\n\nvar ciclos = msg2.payload[23];\nvar Mciclos =((1000)*(msg2.payload[24]));\n\n\nmsg2= {\n    payload:{\n        PRENSA_CICLOS:(ciclos+Mciclos)\n}};\n\n    \nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2110.1627502441406,"y":423.96398544311523,"wires":[["d4c6f65a.55a18"],["96ef6800.4b4bd8"]]},{"id":"d3de7088.a19c","type":"delay","z":"3fa7f249.e9d566","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1757.3127136230469,"y":550.5473289489746,"wires":[["b342f5d7.c59e78","c1008a8f.55427"]]},{"id":"fededba1.6c3a08","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Modo Auto M2.0 ON/OFF","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1235.346004486084,"y":1550.2138724327087,"wires":[["9192c4ac.87a6c"],["af09c9c.9eea0b8"]]},{"id":"e5624514.eed6b8","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Parar Maquina\"});\nreturn null;","outputs":1,"noerr":0,"x":2146.712677001953,"y":1433.213954925537,"wires":[["510067be.e67ce"]]},{"id":"b4b4e58d.186368","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"M31.11\"});\nreturn null;","outputs":1,"noerr":0,"x":2145.212677001953,"y":1511.213954925537,"wires":[["8d818dc2.9e593"]]},{"id":"b492626e.396a98","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Produzir\"});\nreturn null;","outputs":1,"noerr":0,"x":2148.105525970459,"y":1558.2782187461853,"wires":[["637a5728.7f2b"]]},{"id":"2b941919.7bf436","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms Desbobinador","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Desbobinador\"});\nreturn null;","outputs":1,"noerr":0,"x":2197.605525970459,"y":1729.2782187461853,"wires":[["5869d098.cad3b"]]},{"id":"28db9d41.ea302a","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2877.3294982910156,"y":1419.913906097412,"wires":[[]]},{"id":"8d818dc2.9e593","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2877.8294982910156,"y":1511.163906097412,"wires":[[]]},{"id":"c4eebc02.09101","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2877.6867027282715,"y":1551.9781699180603,"wires":[[]]},{"id":"5869d098.cad3b","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2877.829402923584,"y":1729.9781613349915,"wires":[[]]},{"id":"9192c4ac.87a6c","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["ade245d0.7b73d"],"x":1397.4127769470215,"y":1536.16388463974,"wires":[]},{"id":"af09c9c.9eea0b8","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1397.103343963623,"y":1571.7829699516296,"wires":[]},{"id":"637a5728.7f2b","type":"function","z":"3fa7f249.e9d566","name":"Muda MbMaquinaProduzindo M1.7","func":"//*****MbMaquinaProduzindo M1.7\nvar modbus = global.get(\"ModBus\");\n    \nif ((modbus[2]) & (1 << 0)) {\n    modbus[1] &= ~(1<<7); //M1.7 igual a 1 produzir\n    node.status({fill:\"red\",shape:\"dot\",text:\"M1.7 = OFF\"});\n} else {\n    modbus[1] |= (1<<7);//M1.7 igual a 0 não produzir\n    node.status({fill:\"green\",shape:\"ring\",text:\"M1.7 = ON\"});\n}\nglobal.set(\"ComandoMaquina\",9);\nglobal.set('ModBus', modbus);//Atualiza registrador global.\nmsg.payload = modbus[1];\n\nreturn msg;","outputs":1,"noerr":0,"x":2394.3126525878906,"y":1558.5807151794434,"wires":[["86cb6885.8e8328"]]},{"id":"86cb6885.8e8328","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Modo Auto M1.7","dataType":"HoldingRegister","adr":"1","server":"d349ffba.2ed7d8","x":2640.3460998535156,"y":1559.264003753662,"wires":[["c4eebc02.09101"],["8eceed8e.d88a58"]]},{"id":"8eceed8e.d88a58","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":2803.329376220703,"y":1593.2640647888184,"wires":[]},{"id":"47762d37.68ecc4","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"MbPrsParar M2.13 & 2.0","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1232.3793144226074,"y":1408.9137568473816,"wires":[["1634c03.308214"],["22e2dc05.1d0bec"]]},{"id":"1634c03.308214","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["ade245d0.7b73d"],"x":1399.4460411071777,"y":1390.8637747764587,"wires":[]},{"id":"22e2dc05.1d0bec","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1399.1365928649902,"y":1425.4829154014587,"wires":[]},{"id":"1fed70fb.05872f","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Modo Auto M2.0 OFF","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1225.8127403259277,"y":1476.91388463974,"wires":[["381474cb.f73ac4"],["9984763c.0e527"]]},{"id":"381474cb.f73ac4","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["ade245d0.7b73d"],"x":1398.8795127868652,"y":1462.8638968467712,"wires":[]},{"id":"9984763c.0e527","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1397.5700798034668,"y":1498.482982158661,"wires":[]},{"id":"8b0e1e9.7342a6","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["b9410cf8.14726"],"x":1141.379451751709,"y":1766.26398229599,"wires":[]},{"id":"510067be.e67ce","type":"function","z":"3fa7f249.e9d566","name":"Parar motor","func":"//muda 3.3\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n// M3.3 igual a 0 Desliga motor\n    modbus[2] &= ~(1<<12);\n    msg.payload = modbus[2];\n    msg2.payload ={ type: 'info', message: 'Desligando motor para reverter...' };\n    msg2.payload.time= new Date();\n    node.status({fill:\"yellow\",shape:\"ring\",text:\"Deslingado\"});\n\nglobal.set(\"MotorLigado\",0);\nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2328.9877014160156,"y":1433.7514305114746,"wires":[["a1cb52b2.d694a8"],["358ef9e9.e1df46"]]},{"id":"358ef9e9.e1df46","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Estado da Maquina","topic":"AplanadoraN/Estado","qos":"0","retain":"false","broker":"4d1bed4f.c5b27c","x":2598.4877014160156,"y":1476.5014305114746,"wires":[]},{"id":"a1cb52b2.d694a8","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Desliga motor M2.12","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":2579.2377014160156,"y":1426.7514305114746,"wires":[["28db9d41.ea302a"],["37bfc6d8.55496a"]]},{"id":"37bfc6d8.55496a","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":2802.9877014160156,"y":1466.0014305114746,"wires":[]},{"id":"ab658c93.2a4f68","type":"mqtt in","z":"3fa7f249.e9d566","name":"Estado","topic":"AplanadoraN/Estado","qos":"0","broker":"83fa336e.ce02e8","x":2031.1544494628906,"y":1901.9389305114746,"wires":[["f13e07c3.2f51d","db9f277c.0d1518"]]},{"id":"f13e07c3.2f51d","type":"debug","z":"3fa7f249.e9d566","name":"MQTT # RAW","active":false,"console":"false","complete":"payload","x":2641.1544494628906,"y":1901.9389305114746,"wires":[]},{"id":"db9f277c.0d1518","type":"function","z":"3fa7f249.e9d566","name":"Store and shift msg","func":"\n\n\n// initialise the counter to 0 if it doesn't exist already\nvar text = context.get('text')|| [];\n\ntext.push(msg);\nif (text.length > 20){\n    text.shift();\n    text.length = 20;\n} \n\n// store the value back\ncontext.set('text',text);\n// make it part of the outgoing msg object\nmsg = {};\nmsg.payload = text;\nreturn msg;\n","outputs":1,"noerr":0,"x":2311.1544494628906,"y":1961.9389305114746,"wires":[["cc34f62f.3be078","cd28f78a.e11c5"]]},{"id":"cc34f62f.3be078","type":"debug","z":"3fa7f249.e9d566","name":"mqtt array","active":false,"console":"false","complete":"payload","x":2631.1544494628906,"y":1981.9389305114746,"wires":[]},{"id":"cd28f78a.e11c5","type":"ui_template","z":"3fa7f249.e9d566","group":"739e3cf9.526db4","name":"MQTT Output","order":1,"width":"12","height":"6","format":"<ul>\n <li ng-repeat=\"x in msg.payload\">\n <font color=\"red\">{{x.topic}}</font>\n    <ul>\n        <li>{{x.payload}}</li>\n    </ul>\n </li>\n</ul>","storeOutMessages":true,"fwdInMessages":true,"x":2641.1544494628906,"y":1941.9389305114746,"wires":[["1db646e7.f1b2f9"]]},{"id":"f7ecf907.bddc2","type":"ui_text_input","z":"3fa7f249.e9d566","name":"Message","label":"Message","group":"739e3cf9.526db4","order":3,"width":"","height":"","mode":"text","delay":"300","topic":"message","x":2041.1544494628906,"y":2021.9389305114746,"wires":[["e1f3e1.997bf42"]]},{"id":"73c83dd9.a699ac","type":"ui_button","z":"3fa7f249.e9d566","name":"Submit","group":"739e3cf9.526db4","order":4,"width":"6","height":"2","label":"SUBMIT","color":"black","icon":"fa-arrow-circle-o-up","payload":"submit","payloadType":"str","topic":"submit","x":2031.1544494628906,"y":2061.9389305114746,"wires":[["e1f3e1.997bf42"]]},{"id":"e1f3e1.997bf42","type":"function","z":"3fa7f249.e9d566","name":"Store and Submit","func":"context.msg = context.msg || {};\n\nswitch (msg.topic){\n    case 'message':\n        context.msg.payload = msg.payload;\n        break;\n    case 'topic':\n        context.msg.topic = msg.payload;\n        break;\n    case 'submit':\n        if(context.msg.topic){\n            return context.msg;\n        }else{\n            context.msg.topic=\"#\"; // set default topic\n            return context.msg;\n        }\n}","outputs":"1","noerr":0,"x":2311.1544494628906,"y":2041.9389305114746,"wires":[["a0f6198a.1ee1d","669b30ba.154ec8"]]},{"id":"a0f6198a.1ee1d","type":"debug","z":"3fa7f249.e9d566","name":"MQTT Monitor","active":false,"console":"false","complete":"true","x":2621.1544494628906,"y":2041.9389305114746,"wires":[]},{"id":"6eba9bf4.e4a804","type":"ui_text_input","z":"3fa7f249.e9d566","name":"Topic","label":"Topic/","group":"739e3cf9.526db4","order":2,"width":"","height":"","mode":"text","delay":300,"topic":"topic","x":2031.1544494628906,"y":1981.9389305114746,"wires":[["e1f3e1.997bf42"]]},{"id":"8db80a4.89d8378","type":"ui_button","z":"3fa7f249.e9d566","name":"Clear","group":"739e3cf9.526db4","order":0,"width":"4","height":"2","label":"CLEAR","color":"black","icon":"fa-trash","payload":"","payloadType":"str","topic":"","x":2031.1544494628906,"y":2101.9389305114746,"wires":[["f7ecf907.bddc2","6eba9bf4.e4a804"]]},{"id":"9637f49c.e77478","type":"comment","z":"3fa7f249.e9d566","name":"MQTT Console with dashboard ","info":"This flow demonstrates how to view MQTT data\n\nIt is also a nice demonstration how you can\nuse an array to shift data into the UI template\n\n\nUI Viewable:\nhttp://localhost:1880/ui\n\nWritten by\nCory Guynn\n2016\nwww.InternetOfLEG0.com","x":2111.1544494628906,"y":1861.9389305114746,"wires":[]},{"id":"669b30ba.154ec8","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Estado da Maquina","topic":"AplanadoraN/Estado","qos":"0","retain":"false","broker":"83fa336e.ce02e8","x":2659.9044799804688,"y":2090.6889305114746,"wires":[]},{"id":"1db646e7.f1b2f9","type":"debug","z":"3fa7f249.e9d566","name":"","active":false,"console":"false","complete":"false","x":2835.076960972377,"y":1941.5044561113627,"wires":[]},{"id":"9b7ccf45.cccf8","type":"inject","z":"3fa7f249.e9d566","name":"Criar estrutura indice","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":3474.8291397094727,"y":1704.0806674957275,"wires":[["cee38c3b.8e1ff"]]},{"id":"b01a9c9.21d5de","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"salvar","collection":"indice","payonly":true,"upsert":false,"multi":true,"operation":"store","x":3982.742519378662,"y":1703.576036453247,"wires":[]},{"id":"cee38c3b.8e1ff","type":"function","z":"3fa7f249.e9d566","name":"collection inicial indice","func":"msg.payload = {\n\t\"_id\": \"indice\",\n\t\"indice_mesagens\": 0\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":3776.196014404297,"y":1703.9028987884521,"wires":[["b01a9c9.21d5de"]]},{"id":"e227669f.500a98","type":"function","z":"3fa7f249.e9d566","name":"indice +1","func":"//Carrega variavel global indice em y\nvar y = global.get(\"Indice_Mongo\");\n\n//monta a mensagem\nmsg.query = { _id: 'indice' }\nmsg.payload = {\n    $set: {\n       \"indice_mesagens\": parseInt(y)\n     }\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":2844.9089126586914,"y":174.88953971862793,"wires":[["30e66ca5.ea3f4c"]]},{"id":"30e66ca5.ea3f4c","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"Atualizar Indice","collection":"indice","payonly":true,"upsert":false,"multi":false,"operation":"update","x":3018.62296295166,"y":175.2396354675293,"wires":[]},{"id":"9de2e77a.92791","type":"inject","z":"3fa7f249.e9d566","name":"Read indice","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":2334.4449768066406,"y":783.0784873962402,"wires":[["36da5e12.7f498a"]]},{"id":"a05cb359.8cb1c8","type":"debug","z":"3fa7f249.e9d566","name":"indice","active":false,"console":"false","complete":"payload","x":3201.905227661133,"y":793.7768468856812,"wires":[]},{"id":"c5465d3e.abe3d","type":"inject","z":"3fa7f249.e9d566","name":"LIMPAR coleção indice","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":false,"x":3485.2699279785156,"y":1544.925136566162,"wires":[["efa738f2.ed0ed8"]]},{"id":"efa738f2.ed0ed8","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"APAGAR TODA A COLLECTION indice","collection":"indice","payonly":true,"upsert":false,"multi":false,"operation":"delete","x":3871.2699279785156,"y":1544.5917625427246,"wires":[]},{"id":"cd73b421.a81c1","type":"function","z":"3fa7f249.e9d566","name":"mudar 1 item apenas","func":"var x = msg.payload;\n\nvar y = global.get(\"Indice_Mongo\");\n\nif (y <= 999){\n    msg.query = { _id: y };\n    msg.payload = {\n        $set: {\n            \"log_mesagens\": x\n        }\n    };\n    y++;\n    global.set(\"Indice_Mongo\",y);\n} else{\n    global.set(\"Indice_Mongo\",1);\n    msg.query = { _id: 1 };\n    msg.payload = {\n        $set: {\n            \"log_mesagens\": x\n        }\n    };\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2569.4399795532227,"y":246.62627792358398,"wires":[["6a86d884.4568c8","571ee897.4e76a","e227669f.500a98"]]},{"id":"6a86d884.4568c8","type":"mongodb out","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"update log_erro","collection":"log_erro","payonly":true,"upsert":true,"multi":true,"operation":"update","x":2852.88436126709,"y":246.02616691589355,"wires":[]},{"id":"cdbbf740.506f3","type":"mongodb in","z":"3fa7f249.e9d566","mongodb":"1ff167d9.b1a58","name":"consulta","collection":"indice","operation":"find","x":2741.291473388672,"y":668.0282497406006,"wires":[["a2b12c17.de2cf"]]},{"id":"a2b12c17.de2cf","type":"function","z":"3fa7f249.e9d566","name":"indice_mesagens","func":"x =msg.payload[0].indice_mesagens;\nglobal.set(\"Indice_Mongo\",x);\n\nmsg.payload =x;\nreturn msg;","outputs":1,"noerr":0,"x":2927.177822113037,"y":667.6765480041504,"wires":[["a05cb359.8cb1c8"]]},{"id":"f822b8a6.dd21e","type":"link in","z":"3fa7f249.e9d566","name":"tabs2","links":["4a288932.ea285"],"x":2073.3126525878906,"y":714.3807334899902,"wires":[["d8337377.c368a8"]]},{"id":"4a288932.ea285","type":"link out","z":"3fa7f249.e9d566","name":"","links":["f822b8a6.dd21e"],"x":1140.3126792907715,"y":1825.18048620224,"wires":[]},{"id":"ecfbe4fe.4db468","type":"comment","z":"3fa7f249.e9d566","name":"Desbobinador","info":"","x":1247.3126792907715,"y":1766.3639578819275,"wires":[]},{"id":"3ac105d8.3c27b2","type":"comment","z":"3fa7f249.e9d566","name":"TABS2","info":"","x":1228.012752532959,"y":1824.3639578819275,"wires":[]},{"id":"ca2751b8.9961b","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"MbPrsSentido M2.14","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1222.646053314209,"y":1629.26398229599,"wires":[["fc75c09a.ff318"],["5113cabd.6496bc"]]},{"id":"fc75c09a.ff318","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["ade245d0.7b73d"],"x":1399.7127799987793,"y":1611.2140002250671,"wires":[]},{"id":"5113cabd.6496bc","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1399.4033317565918,"y":1645.8331408500671,"wires":[]},{"id":"64145325.cee064","type":"function","z":"3fa7f249.e9d566","name":"ComandoMaquina0","func":"global.set(\"ComandoMaquina\",0);\nreturn msg;","outputs":1,"noerr":0,"x":2877.2127990722656,"y":1630.6139793395996,"wires":[[]]},{"id":"f55e6946.427d9","type":"function","z":"3fa7f249.e9d566","name":"Delay 50ms","func":"setTimeout(function() {\n    node.send(msg);\n}, 50);\nnode.status({fill:\"yellow\",shape:\"dot\",text:\"Reverter prensa\"});\nreturn null;","outputs":1,"noerr":0,"x":2146.9889221191406,"y":1642.9140367507935,"wires":[["25c02c1f.dd1634"]]},{"id":"25c02c1f.dd1634","type":"function","z":"3fa7f249.e9d566","name":"Parar motor","func":"//muda 3.3\nvar mensagens = global.get(\"mensagens\");\nvar modbus = global.get(\"ModBus\");\nvar msg2 = {};\n\n// M3.3 igual a 0 Desliga motor\n    modbus[2] &= ~(1<<12);\n    msg.payload = modbus[2];\n    msg2.payload ={ type: 'info', message: 'Desligando motor para reverter...' };\n    msg2.payload.time= new Date();\n    node.status({fill:\"yellow\",shape:\"ring\",text:\"Deslingado\"});\n\nglobal.set(\"MotorLigado\",0);\nglobal.set('ModBus', modbus);//Atualiza registrador global\nreturn [msg, msg2];","outputs":"2","noerr":0,"x":2323.9794006347656,"y":1642.6139793395996,"wires":[["52dbae13.c0fb5"],["7eba64ba.742d74"]]},{"id":"52dbae13.c0fb5","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Desliga motor M2.12","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":2582.979522705078,"y":1636.6139793395996,"wires":[["64145325.cee064"],[]]},{"id":"7eba64ba.742d74","type":"mqtt out","z":"3fa7f249.e9d566","name":"Topico Estado da Maquina","topic":"AplanadoraN/Estado","qos":"0","retain":"false","broker":"4d1bed4f.c5b27c","x":2603.979522705078,"y":1686.6139793395996,"wires":[]},{"id":"e33c6700.f7a53","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Desliga & zerar tudo!","dataType":"HoldingRegister","adr":"2","server":"d349ffba.2ed7d8","x":1222.0958557128906,"y":1701.980556488037,"wires":[["b7de3cd5.ca76c8"],["726f645c.968ab4"]]},{"id":"726f645c.968ab4","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":1398.8757362365723,"y":1719.6619510650635,"wires":[]},{"id":"e19a42f.3b2f1c","type":"link in","z":"3fa7f249.e9d566","name":"","links":["b7de3cd5.ca76c8"],"x":1529.3416776657104,"y":626.7100200653076,"wires":[["7d990703.61a9e"]]},{"id":"b7de3cd5.ca76c8","type":"link out","z":"3fa7f249.e9d566","name":"reset maquina","links":["e19a42f.3b2f1c"],"x":1399.9250106811523,"y":1684.543140411377,"wires":[]},{"id":"36da5e12.7f498a","type":"function","z":"3fa7f249.e9d566","name":"Paginação ","func":"msg.limit = 5;\nmsg.skip = 0;\nreturn msg;","outputs":1,"noerr":0,"x":2546.0624084472656,"y":719.7640342712402,"wires":[["cdbbf740.506f3"]]},{"id":"1cc02710.0ad2e9","type":"comment","z":"3fa7f249.e9d566","name":"Consulta MongoDB por string","info":"$options => i for case insensitive search\n\nStart with string\n\ndb.collection.find({zip:{'$regex' : '^string', '$options' : 'i'}})\nEnd with string\n\ndb.collection.find({zip:{'$regex' : 'string$', '$options' : 'i'}})\nContains string\n\ndb.collection.find({zip:{'$regex' : 'string', '$options' : 'i'}})\nDoesn't Contains string\n\ndb.collection.find({zip:{'$regex' : '^((?!string).)*$', '$options' : 'i'}})\nKeep this as a bookmark, and a reference for any other alterations you may need. http://www.cheatography.com/davechild/cheat-sheets/regular-expressions/","x":3689.3458557128906,"y":2150.1637840270996,"wires":[]},{"id":"dcaed71e.5eb318","type":"function","z":"3fa7f249.e9d566","name":"Exemplo de consulta","func":"msg.limit = parseInt(msg.req.query.size) || 10;\nmsg.skip = ((parseInt(msg.req.query.page) || 1) - 1) * (parseInt(msg.req.query.page) || 1);\nmsg.payload = {nome: {'$regex' : msg.payload.nome, '$options' : 'i'}}\nreturn msg;","outputs":1,"noerr":0,"x":3669.3458557128906,"y":2110.1637840270996,"wires":[[]]},{"id":"33be9f4f.89e65","type":"function","z":"3fa7f249.e9d566","name":"Desliga se ociosa","func":"var modbus = global.get(\"ModBus\");\nvar tempo = global.get(\"tempo\");\n\nif (((modbus[3]) & (1 << 3))){\n    var atrazo = new Date().getTime();\n    var diff = Math.round((parseInt((atrazo - tempo))/60000));\n    \n    node.status({fill:\"green\",shape:\"dot\",text:\"Diferença de tempo em min = \"+ diff});\n}else {\n    var start = new Date().getTime();\n    global.set(\"tempo\",start);\n    node.status({fill:\"green\",shape:\"dot\",text:\"Motor Desligado \"});\n}\nreturn msg;","outputs":1,"noerr":0,"x":2162.2909545898438,"y":892.8616256713867,"wires":[["8f14ac6.3c164d"]]},{"id":"e27a796f.a5e7e8","type":"link out","z":"3fa7f249.e9d566","name":"Comando para ler todo ModBus","links":["ade245d0.7b73d"],"x":2878.0846252441406,"y":837.1472434997559,"wires":[]},{"id":"5354645a.bd1734","type":"link out","z":"3fa7f249.e9d566","name":"Erro ModBus","links":["2afb58ae.609598"],"x":2877.775192260742,"y":872.7663288116455,"wires":[]},{"id":"23454e80.15782a","type":"modbustcp-no-pooling-write","z":"3fa7f249.e9d566","name":"Desliga Motor Prensa M3.3","dataType":"HoldingRegister","adr":"3","server":"d349ffba.2ed7d8","x":2711.045913696289,"y":854.0091648101807,"wires":[["e27a796f.a5e7e8"],["5354645a.bd1734"]]},{"id":"1a14dac7.440c7d","type":"debug","z":"3fa7f249.e9d566","name":"","active":true,"console":"false","complete":"false","x":3625.3124389648438,"y":338.49731063842773,"wires":[]},{"id":"c1008a8f.55427","type":"subflow:88bd08dd.41c838","z":"3fa7f249.e9d566","name":"Chrome Start","x":2007.8333129882812,"y":590.3277606964111,"wires":[]},{"id":"7d990703.61a9e","type":"subflow:cd40767d.83a838","z":"3fa7f249.e9d566","name":"Reset all mongoDB N3","x":1716.1355438232422,"y":626.9614028930664,"wires":[["b342f5d7.c59e78"]]},{"id":"4d1bed4f.c5b27c","type":"mqtt-broker","z":"3fa7f249.e9d566","broker":"localhost","port":"1883","clientid":"","usetls":false,"verifyservercert":true,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willRetain":null,"willPayload":"","birthTopic":"","birthQos":"0","birthRetain":null,"birthPayload":""},{"id":"d349ffba.2ed7d8","type":"modbustcp-no-pooling-server","z":"3fa7f249.e9d566","host":"192.168.0.174","port":"502","unit_id":"1"},{"id":"1ff167d9.b1a58","type":"mongodb","z":"3fa7f249.e9d566","hostname":"127.0.0.1","port":"27017","db":"db","name":""},{"id":"b07224c0.b4a83","type":"modbustcp-no-pooling-server","z":"3fa7f249.e9d566","host":"192.168.0.174","port":"502","unit_id":"1"},{"id":"83fa336e.ce02e8","type":"mqtt-broker","z":"3fa7f249.e9d566","broker":"localhost","port":"1883","clientid":"","usetls":false,"verifyservercert":true,"compatmode":true,"keepalive":"60","cleansession":true,"willTopic":"","willQos":"0","willRetain":null,"willPayload":"","birthTopic":"","birthQos":"0","birthRetain":null,"birthPayload":""},{"id":"739e3cf9.526db4","type":"ui_group","z":"3fa7f249.e9d566","name":"Default","tab":"3711d8cd.7bc9e8","disp":true,"width":"12"},{"id":"3711d8cd.7bc9e8","type":"ui_tab","z":"3fa7f249.e9d566","name":"MQTT","icon":"dashboard"}]